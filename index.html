<!DOCTYPE html>
<html lang="pt" translate="no">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<meta name="theme-color" content="#000000">
<!-- üõë IMPORTANTE PARA IMAGENS NO SKETCHWARE -->
<meta name="referrer" content="no-referrer">
<meta name="google" content="notranslate">
<title>Njila Ai Enterprise V40 Offline</title>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
/* --- CORE & RESET --- */
.goog-te-banner-frame { display: none !important; }
body { top: 0px !important; }
font { background-color: transparent !important; box-shadow: none !important; }

/* --- LAYOUT PRINCIPAL --- */
html, body { width: 100%; height: 100%; overflow: hidden; margin: 0; padding: 0; background: var(--bg-body); color: var(--text-primary); display: flex; position: fixed; overscroll-behavior-x: none; }

::selection { background: rgba(0, 229, 255, 0.3) !important; color: #fff !important; }
.msg-bubble, .msg-text-content, .code-block, pre, code, .input-field, textarea { -webkit-user-select: text !important; user-select: text !important; }
* { box-sizing: border-box; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; font-weight: 500; } 
strong, b, h1, h2, h3, h4, h5, h6 { font-weight: 800 !important; }

/* Quebra de texto inteligente */
p, h1, h2, h3, h4, h5, h6, span, li, div, .msg-text-content { overflow-wrap: break-word; word-wrap: break-word; word-break: normal; max-width: 100%; }
.msg-text-content ul, .msg-text-content ol { margin: 0; padding-left: 18px; list-style-position: outside; }
.msg-text-content li { margin-bottom: 6px; padding-left: 0; display: list-item !important; text-align: left; }

img, video, canvas, svg { max-width: 100%; height: auto; }

:root { 
    --bg-body: #000000; --bg-sidebar: #050505; --bg-card: #121212; --bg-input: #151515; 
    --border: #333; --text-primary: #ECECEC; --text-secondary: #9aa0a6; 
    --accent: #4285F4; --accent-cyan: #00E5FF; --code-header: #2d2e30; --code-body: #1e1f20;
    --toast-bg: #323232; --alert-bg: #252525; --error: #ff4444;
}

/* --- ANIMA√á√ÉO DE PENSAR --- */
.typing-indicator { display: inline-flex; align-items: center; gap: 4px; padding: 12px 16px; background: rgba(255,255,255,0.05); border-radius: 12px; margin-top: 5px; width: fit-content; border: 1px solid rgba(255,255,255,0.1); }
.typing-dot { width: 6px; height: 6px; background: var(--accent); border-radius: 50%; animation: bounce 1.4s infinite ease-in-out both; }
.typing-dot:nth-child(1) { animation-delay: -0.32s; }
.typing-dot:nth-child(2) { animation-delay: -0.16s; }
@keyframes bounce { 0%, 80%, 100% { transform: scale(0); opacity: 0.5; } 40% { transform: scale(1); opacity: 1; } }

/* --- HERO SCREEN (2x2 P√çLULAS) --- */
.hero-container { margin: auto; width: 100%; max-width: 700px; padding: 20px; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; min-height: 60vh; animation: heavySlide 0.6s ease; }
.hero-logo { font-size: 32px; font-weight: 600; margin-bottom: 5px; color: #fff; letter-spacing: -1px; width: 100%; text-align: center; }
.hero-sub { color:var(--text-secondary); margin-bottom:40px; font-size:16px; font-weight: 400; }
.cards-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; width: 100%; max-width: 400px; margin-top: 20px; }
.suggestion-pill { background: transparent; padding: 12px 20px; border-radius: 50px; cursor: pointer; transition: 0.2s; border: 1px solid rgba(255,255,255,0.15); text-align: center; display: flex; align-items: center; gap: 10px; width: auto; min-width: 140px; justify-content: center; }
.suggestion-pill:hover { border-color: var(--accent); background: rgba(66, 133, 244, 0.05); transform: translateY(-2px); }
.card-emoji { font-size: 18px; }
.card-title { font-size: 13px; font-weight: 600; color: #fff; white-space: nowrap; }

/* --- INPUT BAR FINO E HORIZONTAL --- */
.input-area { 
    padding: 0; 
    display: flex; justify-content: center; position: fixed; bottom: 0; left: 0; width: 100%; z-index: 50; 
    background: var(--bg-body); border-top: 1px solid rgba(255,255,255,0.08);
}
.input-bar-container {
    width: 100%; display: flex; align-items: flex-end; padding: 8px 5px 8px 10px; gap: 8px; background: var(--bg-input); min-height: 50px;
}
.icons-left { display: flex; align-items: center; gap: 12px; padding-bottom: 8px; }
.input-icon-btn { color: var(--text-secondary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; background: transparent; border: none; padding: 0; }
.input-icon-btn:hover { color: #fff; }
.input-icon-btn svg { width: 22px; height: 22px; stroke-width: 1.5px; }

.input-field-wrap { flex-grow: 1; display: flex; flex-direction: column; justify-content: center; min-width: 0; position: relative; }

/* PISTA DE ARQUIVOS (Horizontal Scroll) */
.file-stack-wrapper { display: none; width: 100%; margin-bottom: 5px; padding-bottom: 2px; }
.file-stack-scroll { display: flex; flex-direction: row; overflow-x: auto; gap: 8px; width: 100%; scrollbar-width: none; white-space: nowrap; align-items: center; }
.file-stack-scroll::-webkit-scrollbar { display: none; }
.mini-thumb { width: 36px; height: 36px; flex-shrink: 0; border-radius: 8px; background-size: cover; background-color: #333; border: 1px solid #444; position: relative; animation: popIn 0.2s ease; display: flex; align-items: center; justify-content: center; }
.mini-thumb-close { position: absolute; top: -3px; right: -3px; background: var(--error); color: white; border-radius: 50%; width: 14px; height: 14px; font-size: 9px; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 2; box-shadow: 0 1px 3px rgba(0,0,0,0.5); }
.file-count-float { position: absolute; right: 0; top: -5px; background: var(--accent); color: white; font-size: 9px; font-weight: 800; padding: 2px 6px; border-radius: 10px; display: none; box-shadow: 0 2px 4px rgba(0,0,0,0.5); z-index: 5; }

.input-field { width: 100%; background: transparent; border: none; color: var(--text-primary); font-size: 15px; padding: 8px 0; resize: none; max-height: 120px; height: 36px; outline: none; line-height: 1.4; }
.action-right-wrap { display: flex; align-items: center; padding-bottom: 4px; padding-left: 5px; }
.action-fab { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; flex-shrink: 0; }
.action-fab.mic { background: rgba(255,255,255,0.1); color: #fff; }
.action-fab.send { background: #fff; color: #000; transform: scale(1); }
.action-fab.stop { background: rgba(255,68,68,0.15); color: #ff6b6b; border: 1px solid #ff6b6b; }
.action-fab svg { width: 20px; height: 20px; }
.input-bar-container.recording { border-top-color: #ff4444; }
.input-bar-container.recording .mic { background: rgba(255, 68, 68, 0.2); color: #ff4444; animation: pulseRed 1s infinite; }
@keyframes popIn { from {transform: scale(0.5); opacity:0;} to {transform: scale(1); opacity:1;} }
@keyframes pulseRed { 0% {box-shadow: 0 0 0 0 rgba(255,68,68,0.4);} 70% {box-shadow: 0 0 0 10px rgba(255,68,68,0);} 100% {box-shadow: 0 0 0 0 rgba(255,68,68,0);} }

/* --- OUTROS ESTILOS --- */
#njila-context-menu { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.9); z-index: 999999; background: #000; border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 99px; padding: 8px 12px; display: none; opacity: 0; transition: 0.15s; box-shadow: 0 10px 40px rgba(0,0,0,0.8); flex-direction: row; align-items: center; gap: 5px; }
.ctx-btn { background: transparent; border: none; color: #fff; padding: 8px 12px; border-radius: 50px; font-size: 13px; font-weight: 600; display: flex; align-items: center; gap: 8px; }
.ctx-sep { width: 1px; height: 16px; background: rgba(255,255,255,0.15); margin: 0 2px; }

.chat-scroll { flex-grow: 1; overflow-y: auto; overflow-x: hidden; padding: 0; display: flex !important; flex-direction: column; width: 100%; position: relative; padding-bottom: 70px; scroll-behavior: auto; }
.chat-container { width: 100%; display: flex; flex-direction: column; padding: 0 20px; margin: 0 auto; max-width: 800px; padding-top: 90px !important; }

.msg-row { margin-bottom: 10px !important; display:flex; flex-direction:column; width: 100%; animation: heavySlide 0.3s ease; }
.msg-row.ai .msg-bubble-wrap { width: 100%; text-align: left; }
.msg-row.user { align-items: flex-end !important; margin-top: 20px !important; margin-bottom: 25px !important; }
.msg-row.user .msg-bubble-wrap { width: auto !important; align-items: flex-end !important; }
.msg-row.ai .msg-bubble { background: transparent !important; border: none !important; padding: 0 !important; color: #ececf1; }
.msg-row.user .msg-bubble { background-color: #2f2f2f !important; border-radius: 20px !important; padding: 10px 15px !important; display: inline-block; max-width: 85%; text-align: left; }

/* GALERIA DO UTILIZADOR */
.user-gallery-scroll { display: flex; flex-direction: row; gap: 5px; overflow-x: auto; max-width: 100%; margin-top: 5px; padding-bottom: 5px; scrollbar-width: none; }
.user-gallery-scroll::-webkit-scrollbar { display: none; }
.user-file-thumb { width: 50px; height: 50px; border-radius: 8px; object-fit: cover; border: 1px solid rgba(255,255,255,0.2); flex-shrink: 0; }
.user-doc-thumb { width: 50px; height: 50px; border-radius: 8px; background: #444; border: 1px solid rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; font-size: 24px; flex-shrink: 0; }

/* IMAGEM DA IA */
.img-wrapper-clean { position: relative; display: flex; justify-content: center; align-items: center; width: 100%; border-radius: 12px; overflow: hidden; margin-bottom: 15px; border: 1px solid #333; background: #111; min-height: 250px; }
.clean-image { width: 100%; height: auto; display: block; object-fit: contain; background-color: #000; }
.img-overlay-btn { position: absolute; bottom: 10px; right: 10px; background: rgba(0,0,0,0.7); color: white; border: 1px solid rgba(255,255,255,0.2); padding: 5px 10px; border-radius: 50px; font-size: 11px; cursor: pointer; display: flex; align-items: center; gap: 5px; backdrop-filter: blur(4px); pointer-events: auto; }

@keyframes heavySlide { 0% { opacity: 0; transform: translateY(15px); } 100% { opacity: 1; transform: translateY(0); } }
@keyframes toastUp { 0% { transform: translate(-50%, 20px); opacity: 0; } 100% { transform: translate(-50%, 0); opacity: 1; } }
@keyframes menuPop { 0% { transform: translate(-50%, -50%) scale(0.9); opacity: 0; } 100% { transform: translate(-50%, -50%) scale(1); opacity: 1; } }
@keyframes pulseBlue { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }
@keyframes cursor-blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
@keyframes fadeInActions { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
@keyframes alertSlideUp { from { transform: translate(-50%, 100%); opacity:0; } to { transform: translate(-50%, 0); opacity:1; } }

#universe-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; pointer-events: none; opacity: 0.3; }

.sidebar { width: 280px; height: 100%; background: var(--bg-sidebar); display: flex; flex-direction: column; padding: 15px; border-right: 1px solid var(--border); z-index: 5000; transition: transform 0.3s ease; }
@media (max-width: 768px) { .sidebar { position: fixed; left: 0; top: 0; transform: translateX(-100%); width: 85%; max-width: 300px; box-shadow: 10px 0 30px rgba(0,0,0,0.5); } .sidebar.open { transform: translateX(0); } }
#mobile-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 4999; display: none; backdrop-filter: blur(4px); }

.sidebar-static-top { padding-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.05); margin-bottom: 10px; flex-shrink: 0; }
.sidebar-search-box { width: 100%; position: relative; }
.sidebar-search-input { width: 100%; background: #151515; border: 1px solid rgba(255,255,255,0.1); padding: 12px 15px; border-radius: 50px; color: white; font-size: 13px; transition: 0.3s; }
.sidebar-search-input:focus { border-color: var(--accent); box-shadow: 0 0 10px rgba(66, 133, 244, 0.2); outline: none; background: #000; }
.sidebar-scroll-area { flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 5px; padding-right: 2px; scrollbar-width: thin; }
.sidebar-action-btn { background: transparent; border: 1px solid rgba(255,255,255,0.1); color: var(--text-primary); padding: 10px 15px; border-radius: 50px; cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 13px; font-weight: 500; transition: 0.2s; margin-bottom: 5px; }
.sidebar-action-btn:hover { border-color: var(--accent); background: rgba(66, 133, 244, 0.05); }

.nav-item-clean { display: flex; align-items: center; padding: 12px 15px; cursor: pointer; color: var(--text-secondary); font-size: 14px; background: transparent; border: 1px solid transparent; border-radius: 50px; transition: all 0.2s; -webkit-user-select: none; user-select: none; margin-bottom: 2px; }
.nav-item-clean:hover { color: var(--text-primary); background: rgba(255,255,255,0.04); }
.nav-item-clean.active { color: #fff !important; font-weight: 600; background: rgba(66, 133, 244, 0.1) !important; border: 1px solid var(--accent) !important; box-shadow: 0 0 10px rgba(66, 133, 244, 0.15); }
.nav-text { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex-grow: 1; pointer-events: none; }

.main-content { flex-grow: 1; position: relative; display: flex; flex-direction: column; z-index: 10; height: 100%; width: 100%; overflow: hidden; }
.top-bar { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); background: rgba(0,0,0,0.3); position: absolute; top:0; width:100%; z-index: 100; gap: 10px; border-bottom: 1px solid rgba(255,255,255,0.03); }
body.chat-active .top-bar { pointer-events: none; border-bottom: none; background: transparent; backdrop-filter: none; }
body.chat-active .top-bar .action-icon, body.chat-active .top-bar .pinned-chip { pointer-events: auto; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); }
.pinned-area { flex-grow: 1; display: flex; justify-content: center; gap: 8px; overflow-x: auto; padding: 0 5px; scrollbar-width: none; }
.pinned-chip { background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.1); border-radius: 50px; padding: 6px 12px; display: flex; align-items: center; gap: 6px; font-size: 11px; white-space: nowrap; cursor: pointer; color: var(--text-secondary); animation: heavySlide 0.3s ease; -webkit-user-select: none; user-select: none; }
.pinned-chip.active { background: var(--accent); color: #fff; font-weight: 700; border-color: var(--accent); }

.profile-trigger { width: 34px; height: 34px; border-radius: 50%; cursor: pointer; position: relative; background: transparent; padding: 2px; flex-shrink: 0; }
.profile-img { width: 100%; height: 100%; border-radius: 50%; background: #000; color: #fff; display: flex; justify-content: center; align-items: center; font-weight: 700; font-size: 14px; border: 2px solid var(--accent); box-sizing: border-box; }

.user-copy-btn { position: absolute; top: 0; left: -35px; color: var(--text-secondary); font-size: 18px; cursor: pointer; opacity: 0.5; padding: 5px; border-radius: 50%; transition: 0.2s; }
.user-copy-btn:hover { opacity: 1; color: var(--accent); background: rgba(255,255,255,0.1); }

#google-menu { position: fixed !important; top: 50% !important; left: 50% !important; transform: translate(-50%, -50%) !important; width: 90%; max-width: 320px; height: auto; background: rgba(15, 15, 15, 0.98); backdrop-filter: blur(15px); border-radius: 30px; border: 1px solid var(--border); padding: 30px 20px; z-index: 6000; display: none; flex-direction: column; align-items: center; box-shadow: 0 0 50px rgba(0,0,0,0.8), 0 0 20px rgba(66, 133, 244, 0.1); animation: menuPop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
.profile-big-avatar { width: 80px; height: 80px; background: #000; color: #fff; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 32px; font-weight: 800; border: 2px solid var(--accent); margin-bottom: 15px; }
.gm-welcome { font-size: 18px !important; text-align: center !important; font-weight: 700 !important; color: #fff; margin-bottom: 5px !important; }
.gm-badge-area { margin-bottom: 25px; }
.gm-badge { font-size: 10px; font-weight: 800; padding: 4px 10px; border-radius: 50px; text-transform: uppercase; letter-spacing: 1px; border: 1px solid; }
.menu-list-wrap { width: 100%; display: flex; flex-direction: column; gap: 5px; }
.menu-item-native { display: grid; grid-template-columns: 30px 1fr 20px; align-items: center; padding: 15px; border-radius: 12px; cursor: pointer; transition: 0.2s; color: var(--text-primary); }
.menu-item-native:hover { background: rgba(255,255,255,0.05); }
.menu-item-native span { font-size: 14px; font-weight: 500; }
.menu-item-native .arrow { font-size: 16px; color: #555; }

.clean-actions-bar { display: flex; gap: 15px; margin-top: 10px; padding-left: 2px; opacity: 0.8; padding-top: 12px; padding-bottom: 0px; margin-bottom: 0; }
.msg-actions { display: none; align-items: center; gap: 15px; margin-top: 15px; opacity: 0; pointer-events: none; padding-left: 0; justify-content: flex-start; transition: opacity 0.5s ease; border-top: 1px solid rgba(255,255,255,0.05); padding-top: 10px; width: 100%; position:relative; overflow: visible !important; }
.msg-actions.visible { display: flex; opacity: 1; pointer-events: auto; animation: fadeInActions 0.5s ease forwards; }
.msg-action-btn { cursor: pointer; color: var(--text-secondary); font-size: 18px; padding: 5px; border-radius: 50%; transition: 0.2s; position: relative; -webkit-user-select: none; user-select: none; display: flex; align-items: center; justify-content: center; width: 35px; height: 35px; }
.msg-action-btn:hover { background: rgba(255,255,255,0.1); color: var(--text-primary); }
.msg-action-btn.active { color: var(--accent); }

::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 10px; }

.plan-card { background: var(--bg-input); border: 1px solid var(--border); border-radius: 20px; padding: 25px; display: flex; flex-direction: column; gap: 15px; margin-bottom: 15px; position: relative; }
.plan-card.highlight { border-color: var(--accent); background: linear-gradient(145deg, rgba(66, 133, 244, 0.05), var(--bg-input)); }
.plan-header { display: flex; justify-content: space-between; align-items: center; }
.plan-name { font-weight: 800; font-size: 18px; color: var(--text-primary); }
.plan-price { font-size: 20px; font-weight: 700; color: var(--accent); }
.plan-desc { font-size: 13px; color: var(--text-secondary); line-height: 1.5; font-weight: 400; }
.plan-btn { padding: 10px 20px; border-radius: 50px; border: none; font-weight: 700; cursor: pointer; font-size: 12px; background: var(--accent); color: #fff; width: 100%; text-transform: uppercase; -webkit-user-select: none; user-select: none; }
.plan-btn.btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text-primary); }

#toast-container { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 99999; pointer-events: none; }
.toast { background: var(--toast-bg); color: #fff; padding: 12px 24px; border-radius: 50px; font-size: 14px; font-weight: 500; box-shadow: 0 10px 30px rgba(0,0,0,0.5); opacity: 0; transition: opacity 0.3s; border: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; gap: 10px; animation: toastUp 0.3s forwards; }
#smart-alert { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 500px; background: var(--alert-bg); border: 1px solid var(--border); border-radius: 16px; padding: 15px 20px; display: none; align-items: center; justify-content: space-between; z-index: 8000; box-shadow: 0 10px 30px rgba(0,0,0,0.4); animation: alertSlideUp 0.3s cubic-bezier(0.25, 1, 0.5, 1); gap: 15px; }
.alert-text { font-size: 13px; color: var(--text-primary); line-height: 1.4; flex-grow: 1; }
.alert-btn { background: var(--accent); color: #fff; border: none; padding: 8px 16px; border-radius: 50px; font-weight: 700; font-size: 12px; cursor: pointer; white-space: nowrap; }

.modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 6000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(8px); }
.modal-box { background: var(--bg-card); width: 100%; max-width: 480px; max-height: 90vh; border-radius: 24px; padding: 0; border: 1px solid var(--border); display: flex; flex-direction: column; overflow:hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
.modal-header-custom { padding: 20px; display: flex; align-items: center; gap: 15px; border-bottom: 1px solid var(--border); background: var(--bg-card); flex-shrink: 0; }
.modal-body-scroll { flex-grow: 1; overflow-y: auto; padding: 25px; }
.sheet-item { padding: 15px; color: var(--text-primary); cursor: pointer; display: flex; gap: 15px; align-items: center; font-size: 16px; font-weight: 500; -webkit-user-select: none; user-select: none; }
.sheet-item:active { background: rgba(255,255,255,0.05); }

.settings-tabs, .legal-tabs { display: flex; border-bottom: 1px solid var(--border); margin-bottom: 20px; justify-content: center; }
.set-tab, .legal-tab { flex: 1; text-align: center; padding: 15px; cursor: pointer; color: var(--text-secondary); border-bottom: 2px solid transparent; font-size: 14px; font-weight: 600; -webkit-user-select: none; user-select: none; }
.set-tab.active, .legal-tab.active { color: var(--accent); border-bottom-color: var(--accent); }
.section-label { font-size: 12px; color: var(--text-secondary); font-weight: 600; text-transform: uppercase; margin-top: 25px; display: block; margin-bottom: 10px; }
.setting-grid { display:flex; gap:8px; margin-top:10px; flex-wrap:wrap; }
.setting-btn { background: var(--bg-input); color: var(--text-secondary); border: 1px solid var(--border); padding: 12px 15px; border-radius: 12px; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 13px; transition: 0.2s; flex: 1 0 40%; justify-content: center; -webkit-user-select: none; user-select: none; }
.setting-btn:hover { background: rgba(255,255,255,0.05); color: var(--text-primary); }
.setting-btn.active-set { background: rgba(66, 133, 244, 0.1); border-color: var(--accent); color: var(--accent); font-weight: 700; }
  
.security-item { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
.sec-label { font-size: 14px; color: var(--text-primary); font-weight: 500; }
.switch { position: relative; display: inline-block; width: 44px; height: 24px; }
.switch input { opacity: 0; width: 0; height: 0; }
.slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--border); transition: .4s; border-radius: 24px; }
.slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
input:checked + .slider { background-color: var(--accent); }
input:checked + .slider:before { transform: translateX(20px); }

.legal-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
.legal-info-box { padding: 15px; border-radius: 12px; border: 1px solid var(--border); display: flex; flex-direction: column; font-size: 11px; }
.box-copilot { background: linear-gradient(135deg, rgba(66, 133, 244, 0.1), transparent); border-color: rgba(66, 133, 244, 0.2); }
.box-limits { background: linear-gradient(135deg, rgba(255, 68, 68, 0.1), transparent); border-color: rgba(255, 68, 68, 0.2); }
.legal-content { display:none; font-size:13px; color:var(--text-secondary); line-height:1.6; }
.legal-content h4 { color:var(--text-primary); margin-top:20px; font-size:14px; margin-bottom:5px; }
.legal-content p { margin-bottom:10px; }
.legal-content.active-content { display:block; }

.gemini-code-block { background: var(--code-body); border-radius: 12px; border: 1px solid var(--border); margin: 20px 0; display: block; width: 100%; max-width: 100%; position: relative; overflow: hidden; }
.gemini-code-header { background: var(--code-header); padding: 8px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 12px; color: var(--text-secondary); font-weight: 600; }
.copy-btn-gemini { background: transparent; border: none; color: var(--text-secondary); cursor: pointer; display: flex; align-items: center; gap: 6px; font-size: 11px; padding: 4px 8px; border-radius: 4px; transition: background 0.2s; }
.copy-btn-gemini:hover { background: rgba(255,255,255,0.1); color: var(--text-primary); }
pre[class*="language-"], pre { background: transparent !important; padding: 15px !important; margin: 0 !important; overflow-x: auto !important; width: 100%; max-width: 100%; border: none !important; white-space: pre !important; scrollbar-width: thin; scrollbar-color: var(--border) transparent; -webkit-user-select: text !important; user-select: text !important; }
code { background: transparent !important; font-family: 'Consolas', 'Monaco', 'Courier New', monospace; font-size: 13px !important; color: #A8C7FA !important; -webkit-user-select: text !important; user-select: text !important; }
  
#login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-body); z-index: 99999; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: transform 0.5s ease; }
.login-card { text-align: center; padding: 40px; border-radius: 24px; background: var(--bg-card); border: 1px solid var(--border); width: 90%; max-width: 380px; }
.btn-google { background: white; color: #1f1f1f; border: none; padding: 12px 20px; border-radius: 50px; font-weight: 500; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; width: 100%; margin-top: 25px; font-size: 15px; }

#pin-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:var(--bg-body); z-index:9000; display:none; flex-direction:column; justify-content:center; align-items:center; }
.pin-dots { display:flex; gap:15px; margin-bottom:30px; }
.pin-dot { width:12px; height:12px; border-radius:50%; background:#444; transition:0.2s; }
.pin-dot.filled { background:var(--text-primary); }
.pin-pad { display:grid; grid-template-columns: repeat(3, 1fr); gap:20px; }
.pin-key { width:70px; height:70px; border-radius:50%; background:var(--bg-card); color:var(--text-primary); font-size:24px; display:flex; justify-content:center; align-items:center; cursor:pointer; -webkit-user-select: none; user-select: none; }
#pin-close-btn { position: absolute; top: 30px; right: 30px; font-size: 30px; color: var(--text-secondary); cursor: pointer; display: none; }

#img-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 7000; display: none; justify-content: center; align-items: center; flex-direction: column; }
#img-full-view { max-width: 95%; max-height: 80%; object-fit: contain; }
</style>
</head>
<body oncontextmenu="return false;">

  <div id="njila-context-menu">
      <button class="ctx-btn" onclick="execCmd('copy')">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
          Copiar
      </button>
      <div class="ctx-sep"></div>
      <button class="ctx-btn" onclick="execCmd('share')">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg>
          Partilhar
      </button>
      <div class="ctx-sep"></div>
      <button class="ctx-btn" onclick="exportFromSelection('pdf')">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#ff4444" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
          PDF
      </button>
  </div>
  <div id="toast-container"></div>
  
  <div id="smart-alert">
      <div id="smart-msg" class="alert-text">Mensagem...</div>
      <button id="smart-btn" class="alert-btn">A√ß√£o</button>
      <span onclick="closeSmartAlert()" style="color:var(--text-secondary); font-size:18px; cursor:pointer; margin-left:10px">‚úï</span>
  </div>

  <div id="modal-input" class="modal-overlay">
    <div class="modal-box" style="width: 90%; max-width: 350px;">
        <div style="padding: 25px;">
            <h3 id="input-title" style="margin:0 0 15px 0; font-size:18px;">Input</h3>
            <input type="text" id="custom-input-field" class="input-field" style="border-bottom:1px solid var(--accent); padding:10px 0; width:100%; font-size:16px;" placeholder="Digite aqui...">
            <div style="display:flex; gap:10px; margin-top:25px; justify-content:flex-end;">
                <button class="plan-btn btn-outline" style="border:none" onclick="closeInputModal()">Cancelar</button>
                <button class="plan-btn" id="btn-input-confirm" style="width:auto">Confirmar</button>
            </div>
        </div>
    </div>
  </div>

  <div id="terms-gatekeeper" style="position:fixed;top:0;left:0;width:100%;height:100%;background:#000;z-index:100000;display:none;justify-content:center;align-items:center;">
    <div class="modal-box" style="height: 100%; max-height: 90vh; width: 95%; max-width: 500px; border: 1px solid var(--accent);">
      <div class="modal-header-custom" style="justify-content: center; flex-direction: column; gap: 5px;">
        <div style="font-size: 30px;">üìú</div>
        <h3 style="margin:0; color:var(--accent); font-size: 18px;">Antes de Come√ßar</h3>
      </div>
      <div class="modal-body-scroll">
         <div class="legal-grid">
           <div class="legal-info-box box-copilot"><h4 style="margin:0 0 10px 0; color:var(--accent); font-size:11px; font-weight:800; letter-spacing:1px; text-transform:uppercase;">CO-PILOTO</h4><ul style="margin:0; padding-left:15px; font-size:11px; color:var(--text-secondary); line-height:1.5;"><li>üöÄ Acelera Ideias</li><li>üìù Melhora Textos</li></ul></div>
           <div class="legal-info-box box-limits"><h4 style="margin:0 0 10px 0; color:#ff6b6b; font-size:11px; font-weight:800; letter-spacing:1px; text-transform:uppercase;">LIMITES</h4><ul style="margin:0; padding-left:10px; font-size:11px; color:var(--text-primary); line-height:1.5; list-style:none;"><li><span style="color:#ff6b6b">‚Ä¢</span> Apoio, n√£o substituto humano.</li><li><span style="color:#ff6b6b">‚Ä¢</span> A IA comete erros.</li></ul></div>
        </div>
        <div class="legal-tabs"><div class="legal-tab active" onclick="switchGateTab('terms')" id="gate-tab-terms">Termos de Uso</div><div class="legal-tab" onclick="switchGateTab('privacy')" id="gate-tab-privacy">Privacidade</div></div>
        <div id="gate-txt-terms" class="legal-content active-content">
           <div style="background:rgba(255,255,255,0.03); padding:15px; border-radius:12px; border:1px solid rgba(255,255,255,0.08); margin-bottom:20px; text-align:center;">
               <p style="margin:0; font-size:13px; color:var(--text-primary); font-style:italic; font-weight:500;">"A IA √© apenas o pincel; <span style="color:var(--accent);">voc√™ √© o artista.</span>"</p>
           </div>
           <p style="text-align:center; color:var(--text-secondary); font-size:11px;">Atualiza√ß√£o: 7-12-2025</p>
           <h4>1. Aceita√ß√£o dos Termos</h4><p>Ao criar uma conta ou utilizar o Njila AI, o utilizador declara que: Leu e compreendeu estes Termos; Concorda com todas as condi√ß√µes descritas.</p>
           <h4>2. Descri√ß√£o do Servi√ßo</h4><p>O Njila AI fornece: Gera√ß√£o de textos por Intelig√™ncia Artificial; Ferramentas de escrita para redes sociais, marketing, estudos e neg√≥cios; Recursos premium mediante assinatura paga.</p>
           <h4>3. Responsabilidades do Utilizador</h4><p>O utilizador concorda em N√ÉO utilizar o Njila AI para: Fraudes, golpes, extors√£o ou esquemas ilegais; Pl√°gio; Discurso de √≥dio. Qualquer viola√ß√£o resultar√° em suspens√£o imediata da conta.</p>
           <h4>4. Propriedade Intelectual</h4><p>O nome Njila.io e Njila AI s√£o propriedade exclusiva. O conte√∫do gerado pela IA pertence ao utilizador, exceto quando viola leis.</p>
           <h4>5. Planos e Pagamentos</h4><p>Os servi√ßos premium s√£o cobrados conforme tabela. Pagamentos n√£o s√£o reembols√°veis ap√≥s o uso das funcionalidades.</p>
           <h4>6. Privacidade e Seguran√ßa</h4><p>O utilizador concorda com a coleta de dados descrita na Pol√≠tica de Privacidade. O Njila.io emprega encripta√ß√£o moderna.</p>
           <h4>7. Limita√ß√£o de Responsabilidade</h4><p>O Njila.io n√£o se responsabiliza por perda de dados causada por erro do utilizador ou interrup√ß√µes tempor√°rias.</p>
           <h4>8. Suspens√£o</h4><p>O Njila.io pode suspender contas que violem os termos ou representem risco.</p>
           <h4>9. Contacto</h4><p>Email: <strong>njilasupote@gmail.com</strong></p>
        </div>
        <div id="gate-txt-privacy" class="legal-content">
           <p style="text-align:center; color:var(--text-secondary); font-size:11px; margin-bottom:20px">√öltima atualiza√ß√£o: 9-12-2025</p>
           <h4>1. Dados que Recolhemos</h4><p>Nome, email, Textos escritos dentro do app; Logs de atividade.</p>
           <h4>2. Como Utilizamos</h4><p>Para melhorar a experi√™ncia, processar pagamentos e aperfei√ßoar a IA. Nunca para publicidade externa.</p>
           <h4>3. Partilha de Dados</h4><p>O Njila.io N√ÉO vende dados. Partilha apenas com processadores de pagamentos e autoridades legais quando obrigat√≥rio.</p>
           <h4>4. Seguran√ßa</h4><p>Dados encriptados e armazenados em servidores seguros.</p>
           <h4>5. Seus Direitos</h4><p>Voc√™ pode solicitar a elimina√ß√£o da conta e dos dados a qualquer momento.</p>
           <h4>6. Contacto</h4><p>Email: <strong>njilasuporte@gmail.com</strong> | WhatsApp: <strong>973185721</strong></p>
        </div>
      </div>
      <div style="padding: 20px; border-top: 1px solid var(--border); text-align: center;">
        <div style="display:flex; align-items:center; gap:10px; justify-content:center; margin-bottom:15px">
           <input type="checkbox" id="chk-accept" style="width:20px; height:20px; accent-color:var(--accent);">
           <label for="chk-accept" style="font-size:13px; color:var(--text-primary);">Li, entendi e concordo.</label>
        </div>
        <button onclick="acceptTerms()" class="btn-google" style="font-weight: 800; background:var(--accent); color:#fff">
           ENTRAR NO NJILA 
        </button>
      </div>
    </div>
  </div>

  <div id="img-overlay">
     <span onclick="closeImgOverlay()" style="position:absolute;top:20px;right:20px;color:white;cursor:pointer;font-size:30px;">‚úï</span>
     <img id="img-full-view">
     <div style="margin-top:20px;display:flex;gap:20px">
        <button class="sidebar-btn-main" style="background:#444; color:white; border:none; padding:10px 20px; border-radius:50px; cursor:pointer;" onclick="downloadCurrentImg()">Baixar</button>
        <button class="sidebar-btn-main" style="background:#444; color:white; border:none; padding:10px 20px; border-radius:50px; cursor:pointer;" onclick="shareCurrentImg()">Partilhar</button>
     </div>
  </div>

  <div id="pin-overlay">
    <span id="pin-close-btn" onclick="closePinSetup()" style="position:absolute; top:30px; right:30px; font-size:30px; color:var(--text-secondary); cursor:pointer;">‚úï</span>
    <div style="font-size:40px; margin-bottom:20px">üîê</div>
    <h2 id="pin-title" style="color:var(--text-primary); margin-bottom:30px">Njila Protected</h2>
    <div class="pin-dots" id="pin-dots"><div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div></div>
    <div class="pin-pad">
       <div class="pin-key" onclick="pressPin(1)">1</div><div class="pin-key" onclick="pressPin(2)">2</div><div class="pin-key" onclick="pressPin(3)">3</div>
       <div class="pin-key" onclick="pressPin(4)">4</div><div class="pin-key" onclick="pressPin(5)">5</div><div class="pin-key" onclick="pressPin(6)">6</div>
       <div class="pin-key" onclick="pressPin(7)">7</div><div class="pin-key" onclick="pressPin(8)">8</div><div class="pin-key" onclick="pressPin(9)">9</div>
       <div class="pin-key" onclick="clearPin()">C</div><div class="pin-key" onclick="pressPin(0)">0</div><div class="pin-key" onclick="checkPin()">OK</div>
    </div>
  </div>

  <div id="login-screen" style="display:none;">
    <div class="login-card">
      <div style="font-size:50px; margin-bottom:15px">üíé</div>
      <h1 id="login-title" style="margin:0; font-size:26px; font-weight:800">Njila</h1>
      <p style="color:var(--text-primary); font-size:14px; margin: 10px 0 20px 0; line-height:1.5">
         Acesso Livre.<br>
         <span style="color:var(--text-secondary); font-size:13px">Sem burocracias. Comece agora.</span>
      </p>
      <div style="text-align:left; width:100%; margin-bottom:15px;">
        <label style="font-size:12px; color:var(--text-secondary); margin-left:10px;">Seu Nome</label>
        <input type="text" id="manual-name" class="input-field" style="background:#2a2a2a; border-radius:12px; padding:12px; width:100%; border:1px solid #444; margin-top:5px;" placeholder="Ex: Jeovany">
      </div>
      <div style="text-align:left; width:100%; margin-bottom:25px;">
        <label style="font-size:12px; color:var(--text-secondary); margin-left:10px;">Seu Melhor Email</label>
        <input type="email" id="manual-email" class="input-field" style="background:#2a2a2a; border-radius:12px; padding:12px; width:100%; border:1px solid #444; margin-top:5px;" placeholder="Ex: email@exemplo.com">
      </div>
      <button id="btn-login-trigger" class="btn-google" onclick="manualLogin()" style="background:var(--accent); color:#fff; font-weight:800;">ENTRAR</button>
      <div style="margin-top:20px; font-size:11px; color:#555; line-height:1.4">
         <span style="font-size:12px; vertical-align:middle">üîí</span>
         Seus dados ficam salvos apenas neste dispositivo.
      </div>
    </div>
  </div>

  <div id="app-container" style="display:none; width:100%; height:100%">
    <div id="universe-canvas"></div>
    <div id="mobile-overlay" onclick="closeAll()"></div>
        <input type="file" id="file-upload-doc" accept=".pdf,.txt,.doc,.docx,application/pdf" multiple style="display:none" onchange="handleFileSelect(event)">
    
    <input type="file" id="file-upload-img" accept="image/*" multiple style="display:none" onchange="handleFileSelect(event)">
    
    <input type="file" id="file-upload-cam" accept="image/*" capture="environment" style="display:none" onchange="handleFileSelect(event)">

    <nav class="sidebar" id="sidebar">
      <div class="sidebar-static-top">
           <div class="sidebar-search-box">
               <input type="text" class="sidebar-search-input" id="chat-search-input" placeholder="üîç Procurar conversa..." onkeyup="filterChats()" onfocus="this.parentElement.style.transform='scale(1.02)'" onblur="this.parentElement.style.transform='scale(1)'">
           </div>
      </div>

      <div class="sidebar-scroll-area">
          <div class="sidebar-action-btn" onclick="startNewChat()">
             <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg> Novo Chat
          </div>
          <div class="sidebar-action-btn" onclick="event.stopPropagation(); openGalleryModal()">
             <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg> Galeria
          </div>
          
          <div class="recent-label" style="font-size:11px; color:var(--text-secondary); margin:15px 0 5px 10px; font-weight:600;">RECENTES</div>
          <div class="chat-list" id="chat-list-container"></div>
      </div>
    </nav>
    <main class="main-content">
      <div class="top-bar">
        <!-- MENU HAMBURGUER SVG -->
        <div class="action-icon" onclick="openSidebar()" style="display:flex; align-items:center; justify-content:center; cursor:pointer;">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
        </div>
        <div class="pinned-area" id="header-pinned-area"></div>
        <div style="display:flex; align-items:center; gap:15px">
          <div class="profile-trigger" onclick="toggleGoogleMenu()"><div class="profile-img" id="header-avatar"></div></div>
        </div>
      </div>

      <!-- MENU GOOGLE COM SVGs -->
      <div id="google-menu">
        <div style="position:absolute;top:20px;right:20px;cursor:pointer; color:#666;" onclick="toggleGoogleMenu()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </div>
        
        <div class="profile-big-avatar" id="big-avatar-letter">J</div>
        
        <div class="gm-welcome" id="gm-welcome">Ol√°!</div>
        <div class="gm-badge-area" id="gm-badge-container">
            <span class="gm-badge" style="border-color:#555; color:#999">FREE</span>
        </div>
        
        <div class="menu-list-wrap">
            <div class="menu-item-native" onclick="openPlanModal()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#9aa0a6" stroke-width="2"><rect x="2" y="5" width="20" height="14" rx="2"></rect><line x1="2" y1="10" x2="22" y2="10"></line></svg>
                <span>Gerir Subscri√ß√£o</span>
                <span class="arrow">></span>
            </div>
            <div class="menu-item-native" onclick="openSettingsModal()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#9aa0a6" stroke-width="2"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                <span>Configura√ß√µes</span>
                <span class="arrow">></span>
            </div>
            <div class="menu-item-native" onclick="openLegalModal()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#9aa0a6" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
                <span>Privacidade & Termos</span>
                <span class="arrow">></span>
            </div>
            <div class="menu-item-native" onclick="openHelpModal()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#9aa0a6" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                <span>Ajuda & Suporte</span>
                <span class="arrow">></span>
            </div>
            <div class="menu-item-native" onclick="doLogout()" style="border-top:1px solid #333; margin-top:10px">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#ff6b6b" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                <span style="color:#ff6b6b">Sair</span>
            </div>
        </div>
      </div>

      <div class="chat-scroll" id="scroll-area">
        
        <div class="hero-container" id="hero-screen">
          <div class="hero-logo" id="hero-welcome-text">Ol√°</div>
          <div class="hero-sub">O que vamos criar hoje?</div>
          <div class="cards-grid">
            <div class="suggestion-pill" onclick="triggerCard('poema')"><span class="card-emoji">ü™∂</span><span class="card-title">Criar Poema</span></div>
            <div class="suggestion-pill" onclick="triggerCard('business')"><span class="card-emoji">üìä</span><span class="card-title">Plano Neg√≥cio</span></div>
            <div class="suggestion-pill" onclick="triggerCard('image')"><span class="card-emoji">üñºÔ∏è</span><span class="card-title">Gerar Imagem</span></div>
            <div class="suggestion-pill" onclick="triggerCard('code')"><span class="card-emoji">üß©</span><span class="card-title">Criar C√≥digo</span></div>
          </div>
        </div>
        
        <div class="chat-container" id="chat-display" style="display:none"></div>
      </div>
      
      <!-- INPUT BAR "SLIM & EDGE-TO-EDGE" -->
      <div class="input-area">
        <div class="input-bar-container" id="main-input-box">
            
            <!-- Icones Esquerda (SVGs elegantes) -->
            <div class="icons-left">
                <!-- C√ÇMARA -->
                <button class="input-icon-btn" onclick="triggerUpload('cam')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>
                </button>
                <!-- GALERIA -->
                <button class="input-icon-btn" onclick="triggerUpload('img')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
                </button>
                <!-- DOCUMENTOS -->
                <button class="input-icon-btn" onclick="triggerUpload('doc')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                </button>
            </div>

            <!-- √Årea Central (Texto) -->
            <div class="input-field-wrap">
                <!-- Stack de arquivos (Horizontal Scroll) -->
                <div class="file-stack-wrapper" id="file-stack-wrapper">
                    <div class="file-stack-scroll" id="file-stack-container"></div>
                    <div class="file-count-float" id="file-count-badge" style="display:none">0</div>
                </div>
                
                <textarea id="user-input" class="input-field" rows="1" placeholder="Mensagem..." oninput="autoResize(this); updateMicSendState()" onfocus="document.getElementById('main-input-box').style.borderColor='var(--accent)'" onblur="document.getElementById('main-input-box').style.borderColor='transparent'"></textarea>
            </div>

            <!-- Bot√£o A√ß√£o Direita (Fixo e Im√≥vel) -->
            <div class="action-right-wrap">
                <div id="mic-btn" class="action-fab mic" onclick="startDictation()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>
                </div>
                <div id="send-btn" class="action-fab send" onclick="sendMessage()" style="display:none;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="2.5"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                </div>
                <div id="stop-btn" class="action-fab stop" onclick="stopGeneration()" style="display:none;">
                    <svg viewBox="0 0 24 24" fill="currentColor" stroke="none"><rect x="6" y="6" width="12" height="12" rx="2"></rect></svg>
                </div>
            </div>

        </div>
      </div>

      <!-- INPUTS OCULTOS -->
      <input type="file" id="file-upload-doc" accept=".pdf,.txt,.doc,.docx,application/pdf" multiple style="display:none" onchange="handleFileSelect(event)">
      <input type="file" id="file-upload-img" accept="image/*" multiple style="display:none" onchange="handleFileSelect(event)">
      <input type="file" id="file-upload-cam" accept="image/*" capture="environment" style="display:none" onchange="handleFileSelect(event)">

    </main>
  </div>

  <div id="chat-options-sheet" class="modal-overlay" onclick="closeSheet()">
     <div style="position: fixed; bottom: 0; left: 0; width: 100%; background: var(--bg-card); border-radius: 24px 24px 0 0; padding: 25px 0 40px 0; z-index: 7000; transform: translateY(100%); transition: transform 0.3s;" id="sheet-content" onclick="event.stopPropagation()">
        <div style="width: 40px; height: 4px; background: var(--border); border-radius: 2px; margin: 0 auto 20px auto;"></div>
        <div class="sheet-item" onclick="sheetAction('pin')"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="17" x2="12" y2="22"></line><path d="M5 17h14v-1.76a2 2 0 0 0-1.11-1.79l-1.78-.9A2 2 0 0 1 15 10.76V6h1a2 2 0 0 0 0-4H8a2 2 0 0 0 0 4h1v4.76a2 2 0 0 1-1.11 1.79l-1.78.9A2 2 0 0 0 5 15.24Z"></path></svg> Afixar</div>
        <div class="sheet-item" onclick="sheetAction('rename')"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg> Renomear</div>
        <div class="sheet-item" onclick="sheetAction('share')"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg> Partilhar</div>
        <div class="sheet-item" style="color:#ff6b6b" onclick="sheetAction('delete')"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#ff6b6b" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg> Eliminar</div>
     </div>
  </div>

  <div id="modal-confirm" class="modal-overlay" style="display:none; z-index:9999;">
    <div class="modal-box" style="text-align:center; padding: 25px;">
        <h3 style="margin-bottom:10px;">Tem a certeza?</h3>
        <p id="confirm-msg" style="color:#aaa; margin-bottom:20px; font-size:14px;">Esta a√ß√£o n√£o pode ser desfeita.</p>
        
        <div style="display:flex; gap:10px; justify-content:center;">
            <button class="plan-btn btn-outline" onclick="closeConfirm()" style="flex:1;">Cancelar</button>
            <button class="plan-btn" id="btn-confirm-yes" style="flex:1; background:var(--error, #ff4444); border:none; color:white;">Apagar</button>
        </div>
    </div>
  </div>

  <div id="modal-gallery" class="modal-overlay" onclick="if(event.target===this) closeModals()">
    <div class="modal-box" style="width:100%;max-width:600px;height:85vh">
        <div class="modal-header-custom"><span onclick="closeModals()" style="cursor:pointer"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg></span><h3 style="margin:0">Galeria</h3></div>
        <div class="modal-body-scroll">
            <div id="gallery-container" style="display:grid;grid-template-columns:1fr 1fr;gap:10px;"></div>
            <div id="gallery-empty" style="text-align:center;color:#666;display:none;margin-top:20px; font-size:13px;">Sem imagens.</div>
        </div>
    </div>
  </div>

  <div id="modal-settings" class="modal-overlay" onclick="if(event.target===this) closeModals()">
    <div class="modal-box">
      <div class="modal-header-custom"><span onclick="closeModals()" style="cursor:pointer"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg></span><h3 style="margin:0">Configura√ß√µes</h3></div>
      <div class="modal-body-scroll">
          <div class="settings-tabs">
              <div class="set-tab active" onclick="switchSetTab('general')" id="tab-general">Geral</div>
              <div class="set-tab" onclick="switchSetTab('security')" id="tab-security">Seguran√ßa üîí</div>
          </div>
          <div id="panel-general">
             <span class="section-label" id="lbl-region">1. Regi√£o & Cultura</span>
             <div class="setting-grid">
                <div class="setting-btn" id="btn-reg-Angola" onclick="setManual('Angola')">üá¶üá¥ Angola</div>
                <div class="setting-btn" id="btn-reg-Brasil" onclick="setManual('Brasil')">üáßüá∑ Brasil</div>
                <div class="setting-btn" id="btn-reg-Portugal" onclick="setManual('Portugal')">üáµüáπ Portugal</div>
                <div class="setting-btn" id="btn-reg-Global" onclick="setManual('Global')">üåç Global</div>
             </div>
             <span class="section-label" id="lbl-lang">2. Idioma / Language</span>
             <div class="setting-grid">
                <div class="setting-btn" onclick="setLanguage('Portugu√™s')">üáµüáπ PT</div>
                <div class="setting-btn" onclick="setLanguage('English')">üá∫üá∏ EN</div>
                <div class="setting-btn" onclick="setLanguage('Mandarin')">üá®üá≥ ZH</div>
                <div class="setting-btn" onclick="setLanguage('Espa√±ol')">üá™üá∏ ES</div>
                <div class="setting-btn" onclick="setLanguage('Fran√ßais')">üá´üá∑ FR</div>
                <div class="setting-btn" onclick="setLanguage('Deutsch')">üá©üá™ DE</div>
                <div class="setting-btn" onclick="setLanguage('Russian')">üá∑üá∫ RU</div>
                <div class="setting-btn" onclick="setLanguage('Arabic')">üá∏üá¶ AR</div>
             </div>
          </div>
          <div id="panel-security" style="display:none">
             <div class="security-item"><div><div class="sec-label">Modo Seguro (MSC)</div></div><label class="switch"><input type="checkbox" id="sw-safemode" onchange="toggleSecurity('safe_mode')"><span class="slider"></span></label></div>
             <div class="security-item"><div><div class="sec-label">Modo An√≥nimo üëª</div></div><label class="switch"><input type="checkbox" id="sw-incognito" onchange="toggleSecurity('incognito')"><span class="slider"></span></label></div>
             <div class="security-item"><div><div class="sec-label">Bloqueio por PIN</div></div><button class="plan-btn btn-outline" style="font-size:11px" onclick="openPinSetup()">Configurar</button></div>
          </div>
      </div>
    </div>
  </div>
  
  <div id="modal-plan" class="modal-overlay" onclick="if(event.target===this) closeModals()">
    <div class="modal-box"><div class="modal-header-custom"><span onclick="closeModals()" style="cursor:pointer"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg></span><h3 style="margin:0">Planos</h3></div><div class="modal-body-scroll" id="plans-grid"></div></div>
  </div>

  <div id="modal-vault" class="modal-overlay" onclick="if(event.target===this) closeModals()">
    <div class="modal-box">
        <div class="modal-header-custom">
            <span onclick="closeModals()" style="cursor:pointer"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg></span>
            <h3 style="margin:0; color:#00E5FF">Cofre Pessoal</h3>
        </div>
        
        <div class="modal-body-scroll">
            <div style="background:rgba(0, 229, 255, 0.08); border:1px solid rgba(0, 229, 255, 0.2); border-radius:16px; padding:20px; text-align:center; margin-bottom:25px;">
                <div style="font-size:30px; margin-bottom:10px;">üõ°Ô∏è</div>
                <h4 style="margin:0 0 5px 0; font-size:15px; color:#fff;">√Årea Blindada</h4>
                <p style="margin:0; font-size:12px; color:var(--text-secondary); line-height:1.5;">
                    O que escreves aqui √© trancado com o teu PIN e salvo na nuvem.<br>
                    Nem a Google, nem o Njila conseguem ler.
                </p>
            </div>

            <div style="position:relative;">
                <textarea id="vault-content" class="input-field" 
                    style="width:100%; height:250px; background:var(--bg-input); border:1px solid var(--border); border-radius:18px; padding:15px; font-family:'Inter', sans-serif; resize:none; line-height:1.6;" 
                    placeholder="Escreve aqui as tuas ideias secretas..."></textarea>
                
                <div id="vault-lock-overlay" style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); backdrop-filter:blur(5px); border-radius:18px; flex-direction:column; justify-content:center; align-items:center; z-index:10;">
                    <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#00E5FF" stroke-width="2" style="margin-bottom:10px"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                    <span style="font-size:12px; color:#fff; font-weight:600;">CONTE√öDO ENCRIPTADO</span>
                </div>
            </div>

            <div style="display:flex; gap:12px; margin-top:20px;">
                <button class="plan-btn btn-outline" onclick="vaultAction('decrypt')" style="flex:1;">
                    Ler
                </button>
                <button class="plan-btn" onclick="vaultAction('encrypt')" style="flex:1; background:#00E5FF; color:#000;">
                    Trancar
                </button>
            </div>
        </div>
    </div>
  </div>

  <div id="modal-legal" class="modal-overlay" onclick="if(event.target===this) closeModals()">
    <div class="modal-box"><div class="modal-header-custom"><span onclick="closeModals()" style="cursor:pointer"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg></span><h3>Legal</h3></div><div class="modal-body-scroll">
    <div class="legal-grid">
           <div class="legal-info-box box-copilot"><h4 style="margin:0 0 10px 0; color:var(--accent); font-size:11px; font-weight:800; letter-spacing:1px; text-transform:uppercase;">CO-PILOTO</h4><ul style="margin:0; padding-left:15px; font-size:11px; color:var(--text-secondary); line-height:1.5;"><li>üöÄ Acelera Ideias</li><li>üìù Melhora Textos</li></ul></div>
           <div class="legal-info-box box-limits"><h4 style="margin:0 0 10px 0; color:#ff6b6b; font-size:11px; font-weight:800; letter-spacing:1px; text-transform:uppercase;">LIMITES</h4><ul style="margin:0; padding-left:10px; font-size:11px; color:var(--text-primary); line-height:1.5; list-style:none;"><li><span style="color:#ff6b6b">‚Ä¢</span> Apoio, n√£o substituto humano.</li><li><span style="color:#ff6b6b">‚Ä¢</span> A IA comete erros.</li></ul></div>
    </div>
    <div class="legal-tabs"><div class="legal-tab active" onclick="switchLegalTab('terms')" id="tab-btn-terms">TERMOS</div><div class="legal-tab" onclick="switchLegalTab('privacy')" id="tab-btn-privacy">PRIVACIDADE</div></div>
    <div id="legal-txt-terms" class="legal-content active-content">
       <div style="background:rgba(255,255,255,0.03); padding:15px; border-radius:12px; border:1px solid rgba(255,255,255,0.08); margin-bottom:25px; text-align:center;">
           <p style="margin:0; font-size:13px; color:var(--text-primary); font-style:italic; font-weight:500;">"Voc√™ det√©m os direitos sobre o que cria. <br><span style="color:var(--accent);">A IA √© apenas o pincel; voc√™ √© o artista.</span>"</p>
       </div>
       <p style="text-align:center; color:var(--text-secondary); font-size:11px; margin-bottom:20px">√öltima atualiza√ß√£o: 7-12-2025</p>
       <h4>1. Aceita√ß√£o dos Termos</h4><p>Ao criar uma conta ou utilizar o Njila AI, o utilizador declara que: Leu e compreendeu estes Termos; Concorda com todas as condi√ß√µes descritas.</p>
       <h4>2. Descri√ß√£o do Servi√ßo</h4><p>O Njila AI fornece: Gera√ß√£o de textos por Intelig√™ncia Artificial; Ferramentas de escrita para redes sociais, marketing, estudos e neg√≥cios; Recursos premium mediante assinatura paga.</p>
       <h4>3. Responsabilidades do Utilizador</h4><p>O utilizador concorda em N√ÉO utilizar o Njila AI para: Fraudes, golpes, extors√£o ou esquemas ilegais; Pl√°gio; Discurso de √≥dio. Qualquer viola√ß√£o resultar√° em suspens√£o imediata da conta.</p>
       <h4>4. Propriedade Intelectual</h4><p>O nome Njila.io e Njila AI s√£o propriedade exclusiva. O conte√∫do gerado pela IA pertence ao utilizador, exceto quando viola leis.</p>
       <h4>5. Planos e Pagamentos</h4><p>Os servi√ßos premium s√£o cobrados conforme tabela. Pagamentos n√£o s√£o reembols√°veis ap√≥s o uso das funcionalidades.</p>
       <h4>6. Privacidade e Seguran√ßa</h4><p>O utilizador concorda com a coleta de dados descrita na Pol√≠tica de Privacidade. O Njila.io emprega encripta√ß√£o moderna.</p>
       <h4>7. Limita√ß√£o de Responsabilidade</h4><p>O Njila.io n√£o se responsabiliza por perda de dados causada por erro do utilizador ou interrup√ß√µes tempor√°rias.</p>
       <h4>8. Suspens√£o</h4><p>O Njila.io pode suspender contas que violem os termos ou representem risco.</p>
       <h4>9. Contacto</h4><p>Email: <strong>njilasuporte@gmail.com</strong></p>
    </div>
    <div id="legal-txt-privacy" class="legal-content">
        <p style="text-align:center; color:var(--text-secondary); font-size:11px; margin-bottom:20px">√öltima atualiza√ß√£o: 9-12-2025</p>
        <h4>1. Dados que Recolhemos</h4><p>Nome, email, Textos escritos dentro do app; Logs de atividade.</p>
        <h4>2. Como Utilizamos</h4><p>Para melhorar a experi√™ncia, processar pagamentos e aperfei√ßoar a IA. Nunca para publicidade externa.</p>
        <h4>3. Partilha de Dados</h4><p>O Njila.io N√ÉO vende dados. Partilha apenas com processadores de pagamentos e autoridades legais quando obrigat√≥rio.</p>
        <h4>4. Seguran√ßa</h4><p>Dados encriptados e armazenados em servidores seguros.</p>
        <h4>5. Seus Direitos</h4><p>Voc√™ pode solicitar a elimina√ß√£o da conta e dos dados a qualquer momento.</p>
        <h4>6. Contacto</h4><p>Email: <strong>njilasuporte@gmail.com</strong> | WhatsApp: <strong>973185721</strong></p>
    </div>
    </div></div>
  </div>
  
  <div id="modal-help" class="modal-overlay" onclick="if(event.target===this) closeModals()">
    <div class="modal-box"><div class="modal-header-custom"><span onclick="closeModals()" style="cursor:pointer"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg></span><h3>Central de Ajuda</h3></div><div class="modal-body-scroll"><div style="background: linear-gradient(135deg, #1E1F20, #28292A); padding: 25px; border-radius: 20px; text-align:center; border: 1px solid var(--border);"><div style="font-size: 40px; margin-bottom: 10px;">ü§ù</div><h4 style="margin:0; font-size:18px;">Estamos aqui para si.</h4><p style="color:var(--text-secondary); font-size:13px; line-height:1.5;">D√∫vidas com a subscri√ß√£o ou feedback do Njila?</p><button class="plan-btn" style="background:#25D366; color:white; margin-top:15px; display:flex; align-items:center; justify-content:center; gap:10px; width:100%" onclick="window.open('https://wa.me/244973185721', '_blank')"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg> Falar no WhatsApp</button></div></div></div>
  </div>
  <script>
// ======================================================
// 3. RENDERIZADOR UI "CLEAN STYLE"
// ======================================================

function appendMsg(t, r, img, anim){
    const b = document.getElementById('chat-display');
    const msgId = 'msg-' + Date.now() + Math.random().toString(36).substr(2,5);
    
    let cleanImgUrl = "";
    if (img) cleanImgUrl = fixDriveLink(img);

    let htmlContent = '';

    if(r === 'ai') {
        if (cleanImgUrl && cleanImgUrl.length > 5) {
            htmlContent += `
                <div class="img-wrapper-clean">
                    <img src="${cleanImgUrl}" 
                         class="clean-image"
                         referrerpolicy="no-referrer" 
                         crossorigin="anonymous"
                         loading="eager"
                         style="display:block;"
                         onerror="this.style.display='none'; this.parentElement.querySelector('.img-retry-btn').style.display='flex';" 
                         onclick="openFullImage('${cleanImgUrl}')">
                    <div class="img-overlay-btn" onclick="event.stopPropagation(); forceDownload('${cleanImgUrl}', this)">
                        ‚¨á Baixar
                    </div>
                    <div class="img-retry-btn" style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; justify-content:center; align-items:center; flex-direction:column; gap:10px; background:#111;">
                        <span style="color:#ff6b6b; font-size:12px;">Falha ao carregar</span>
                        <button class="plan-btn" style="width:auto; padding:5px 15px; font-size:10px;" onclick="reloadImage(this, '${cleanImgUrl}')">Recarregar</button>
                    </div>
                </div>`;
        }

        if (t && t.trim().length > 0) {
            htmlContent += `<div class="msg-text-content" id="${msgId}" style="line-height:1.6; min-height:20px;">${marked.parse(t||'')}</div>`;
        }

        htmlContent += `<div class="clean-actions-bar" id="actions-${msgId}" style="display:flex; gap:15px; margin-top:10px; opacity:0; transition:opacity 0.5s;"></div>`;

    } else {
        // MENSAGEM DO UTILIZADOR - L√ìGICA DE FICHEIROS HORIZONTAL
        if (t.includes('user-gallery-scroll')) {
             htmlContent = t; // J√° vem formatado
        } else if (cleanImgUrl) {
             htmlContent = `<div class="msg-bubble">${marked.parse(t||'')} <br><img src="${cleanImgUrl}" style="max-width:100px; margin-top:5px; border-radius:8px;"></div>`;
        } else {
             htmlContent = `<div class="msg-bubble">${t.replace(/\n/g,'<br>')}</div>`;
        }
        htmlContent += `<div style="text-align:right; margin-top:5px; opacity:0.5;"><span onclick="copyText('${msgId}')" style="cursor:pointer; font-size:12px">‚úé</span></div>`;
    }

    const d = document.createElement('div'); 
    d.className = `msg-row ${r}`; 
    
    if (r === 'ai') {
        d.innerHTML = `<div class="msg-bubble-wrap" style="width:100%; text-align:left;">${htmlContent}</div>`;
    } else {
        d.innerHTML = `<div class="msg-bubble-wrap" style="display:flex; flex-direction:column; align-items:flex-end;">${htmlContent}</div>`;
    }

    b.appendChild(d);

    if(r === 'ai') {
        if(anim && !img && t.trim().length > 0) {
            typeWriterFluid(t, msgId, () => injectCleanActions(msgId, cleanImgUrl));
        } else {
            injectCleanActions(msgId, cleanImgUrl);
            formatCodeBlocks(d);
        }
    }
    
    scrollToBottom();
}

function reloadImage(btn, url) {
    const wrapper = btn.closest('.img-wrapper-clean');
    const img = wrapper.querySelector('img');
    const retryDiv = wrapper.querySelector('.img-retry-btn');
    
    retryDiv.style.display = 'none';
    img.style.display = 'block';
    
    let newUrl = url;
    if(newUrl.includes('&retry=')) newUrl = newUrl.split('&retry=')[0];
    newUrl += "&retry=" + Date.now();
    
    img.src = newUrl;
}

function injectCleanActions(msgId, imgUrl) {
    const actionContainer = document.getElementById(`actions-${msgId}`);
    if(!actionContainer) return;

    const svgCopy = `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>`;
    const svgSync = `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 4v6h-6"></path><path d="M1 20v-6h6"></path><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>`;
    const svgShare = `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg>`;
    const svgLike = `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"></path></svg>`;
    const svgDislike = `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 15v4a3 3 0 0 0 3 3l4-9V2H5.72a2 2 0 0 0-2 1.7l-1.38 9a2 2 0 0 0 2 2.3zm7-13h2.67A2.31 2.31 0 0 1 22 4v7a2.31 2.31 0 0 1-2.33 2H17"></path></svg>`;

    let buttonsHtml = `
        <div class="msg-action-btn" onclick="copyText('${msgId}')" title="Copiar" style="color:#acacbe;">${svgCopy}</div>
        <div class="msg-action-btn" onclick="resurrectMsg()" title="Regenerar" style="color:#acacbe;">${svgSync}</div>
        <div class="msg-action-btn" onclick="shareMsg('${msgId}')" title="Partilhar" style="color:#acacbe;">${svgShare}</div>
        <div style="flex-grow:1"></div>
        <div class="msg-action-btn" onclick="rateMsg(this)" style="color:#acacbe;">${svgLike}</div>
        <div class="msg-action-btn" onclick="rateMsg(this)" style="color:#acacbe; margin-left:5px;">${svgDislike}</div>
    `;

    actionContainer.innerHTML = buttonsHtml;
    actionContainer.style.opacity = '1'; 
}

// PEDIDO 3: SCROLL APENAS MANUAL OU NOVO EVENTO
let isUserScrolling = false;
document.addEventListener('DOMContentLoaded', () => {
    const scrollArea = document.getElementById('scroll-area');
    scrollArea.addEventListener('scroll', () => {
        const distanceToBottom = scrollArea.scrollHeight - scrollArea.scrollTop - scrollArea.clientHeight;
        isUserScrolling = distanceToBottom > 60;
    });
});

function scrollToBottom() {
    if (!isUserScrolling) {
        const scrollArea = document.getElementById('scroll-area');
        scrollArea.scrollTo({ top: scrollArea.scrollHeight, behavior: 'smooth' });
    }
}

function typeWriterFluid(text, elementId, onComplete) {
    const element = document.getElementById(elementId);
    if(!element) return;
    
    isGenerating = true;
    updateMicSendState();

    let i = 0; const chunkSize = 5; 
    element.innerHTML = ''; 
    
    function type() {
        if (!isGenerating) { if(onComplete) onComplete(); return; }
        if (i < text.length) {
            const chunk = text.substr(0, i + chunkSize); 
            element.innerHTML = marked.parse(chunk); 
            i += chunkSize;
            // REMOVIDO: scrollToBottom() AQUI (P√ÅRA DE DESCER SOZINHO)
            typerTimeout = setTimeout(type, 10); 
        } else {
            element.innerHTML = marked.parse(text); 
            const row = element.closest('.msg-row');
            if(row) formatCodeBlocks(row);
            
            isGenerating = false; 
            updateMicSendState();
            scrollToBottom(); 
            if(onComplete) onComplete(); 
        }
    }
    type();
}
// ======================================================
// üöÄ NJILA ANDROID BRIDGE 2.0
// ======================================================
const NJILA_CLOUD_URL = "https://script.google.com/macros/s/AKfycbwVhs25a3hriNLTpvoSozarQoJzM-SqdKHtWDhPDLPSh_ZJyqM0gEdLiUIEKjz138l7/exec";

console.log("Njila Bridge 2.0 - Active");

const google = {
  script: {
    run: createRunner(null, null)
  }
};

function createRunner(onSuccess, onFailure) {
  return new Proxy({}, {
    get: function(target, prop) {
      if (prop === 'withSuccessHandler') {
        return function(f) { return createRunner(f, onFailure); };
      }
      if (prop === 'withFailureHandler') {
        return function(f) { return createRunner(onSuccess, f); };
      }
      return function(...args) {
        fetch(NJILA_CLOUD_URL, {
            method: 'POST',
            redirect: 'follow',
            headers: { "Content-Type": "text/plain;charset=utf-8" },
            body: JSON.stringify({ func: prop, args: args })
        })
        .then(response => response.json())
        .then(data => {
            if(data.error) {
                if(onFailure) onFailure(data.error);
                else showToast("Erro: " + data.error);
            } else {
                if(onSuccess) onSuccess(data.result);
            }
        })
        .catch(err => {
            if(onFailure) onFailure(err);
            else showToast("Verifique a Internet.");
        });
      };
    }
  });
}

// --- 1. CONFIGURA√á√ïES E DADOS ---
const REGION_DATA={
    'Angola':{moeda:'Kz',precoBasic:'GR√ÅTIS',preco:'9.500',precoUltra:'22.000'},
    'Brasil':{moeda:'R$',precoBasic:'GR√ÅTIS',preco:'29,90',precoUltra:'89,90'},
    'Portugal':{moeda:'‚Ç¨',precoBasic:'GR√ÅTIS',preco:'9.99',precoUltra:'24.99'},
    'Global':{moeda:'$',precoBasic:'FREE',preco:'9.99',precoUltra:'24.99'}
};

const deviceId = localStorage.getItem('njila_device_id') || 'dev_' + Date.now();
if (!localStorage.getItem('njila_device_id')) localStorage.setItem('njila_device_id', deviceId);

let state={chatId:null, region:'Angola', language:'Portugu√™s', fileList:[], security:{pin:null,incognito:false,safe_mode:true}, currentImgUrl:null, deviceId: deviceId, targetChatId:null, userEmail: null, pinnedChats: [], pinMode: 'UNLOCK'};

let activeGenToken = 0; 
let thinkingInterval, isGenerating = false, typerTimeout;

function showToast(msg) {
    const c = document.getElementById('toast-container');
    if(!c) return;
    const d = document.createElement('div'); d.className = 'toast';
    d.innerHTML = `<span style="font-size:16px; color:var(--accent)">‚ÑπÔ∏è</span> ${msg}`;
    c.appendChild(d); setTimeout(() => { d.style.opacity = '0'; setTimeout(()=>d.remove(),300); }, 3000);
}

function showSmartAlert(msg, btnText, actionCallback) {
    const alertBox = document.getElementById('smart-alert');
    document.getElementById('smart-msg').innerText = msg;
    const btn = document.getElementById('smart-btn');
    if(btnText) { btn.style.display = 'block'; btn.innerText = btnText; btn.onclick = () => { closeSmartAlert(); actionCallback(); }; } 
    else { btn.style.display = 'none'; }
    alertBox.style.display = 'flex';
}
function closeSmartAlert() { document.getElementById('smart-alert').style.display = 'none'; }

function showError(type, msg) {
    let btnText = "OK"; let action = () => {};
    if (type === 'PLAN_LIMIT') { btnText = "Ver Planos"; action = openPlanModal; } 
    else if (type === 'NETWORK') { btnText = "Tentar"; action = () => { showToast("A reconectar..."); }; }
    showSmartAlert(msg, btnText, action);
}

function updateMicSendState(){
    const t = document.getElementById('user-input');
    const hasText = t.value.trim().length > 0;
    const hasFiles = state.fileList.length > 0;

    if(isGenerating) {
        document.getElementById('mic-btn').style.display = 'none'; 
        document.getElementById('send-btn').style.display = 'none'; 
        document.getElementById('stop-btn').style.display = 'flex';
    } else {
        document.getElementById('stop-btn').style.display = 'none';
        if(hasText || hasFiles) {
             document.getElementById('mic-btn').style.display = 'none';
             document.getElementById('send-btn').style.display = 'flex';
        } else {
             document.getElementById('mic-btn').style.display = 'flex';
             document.getElementById('send-btn').style.display = 'none';
        }
    }
}

function startDictation() {
    if (window.webkitSpeechRecognition) {
        const recognition = new webkitSpeechRecognition();
        recognition.lang = state.language === 'Portugu√™s' ? 'pt-AO' : 'en-US'; 
        
        const bar = document.querySelector('.input-bar-container');
        
        recognition.onstart = function() { 
             showToast("A ouvir..."); 
             bar.classList.add('recording');
             document.getElementById('mic-btn').style.color = '#ff4444'; 
        };
        recognition.onend = function() { 
             bar.classList.remove('recording');
             document.getElementById('mic-btn').style.color = ''; 
        };
        recognition.onresult = function(e) {
            const t = document.getElementById('user-input'); t.value += (t.value ? ' ' : '') + e.results[0][0].transcript; autoResize(t); updateMicSendState();
        }; recognition.start();
    } else { showToast("Seu navegador n√£o suporta ditado."); }
}

function stopGeneration() {
    activeGenToken++; 
    isGenerating = false; 
    stopThinking();
    if(typerTimeout) clearTimeout(typerTimeout); 
    
    // CORTE VISUAL IMEDIATO DO STOP
    const thinkingEls = document.querySelectorAll('.typing-indicator');
    thinkingEls.forEach(el => { const row = el.closest('.msg-row'); if(row) row.remove(); });
    
    updateMicSendState(); 
    showToast("Interrompido.");
}

function startThinking(id) { }
function stopThinking() { }

function cleanupUI(bubbleIdToRemove) {
    if(bubbleIdToRemove) {
        const el = document.getElementById(bubbleIdToRemove);
        if(el) { const row = el.closest('.msg-row'); if(row) row.remove(); }
    }
    isGenerating = false; updateMicSendState();
}

function bumpChatToTop(chatId) {
    let chats = JSON.parse(localStorage.getItem('njila_chats') || '[]');
    const index = chats.findIndex(c => c.id === chatId);
    if (index > -1) {
        const [chat] = chats.splice(index, 1);
        chats.unshift(chat); // Move pro topo
        localStorage.setItem('njila_chats', JSON.stringify(chats));
        renderChatList(chats);
    }
}
// --- 1. FUN√á√ÉO VISUAL PARA ATUALIZAR O PLANO ---
function updateUserBadge(planName) {
    const badgeEl = document.querySelector('.gm-badge');
    if (!badgeEl || !planName) return;

    const plan = planName.toUpperCase().trim();
    badgeEl.innerText = plan;

    // Atualiza cores baseadas no plano
    if (plan === 'PRO') { 
        badgeEl.style.color = '#4285F4'; // Azul Google
        badgeEl.style.borderColor = '#4285F4'; 
        badgeEl.style.backgroundColor = 'rgba(66, 133, 244, 0.1)'; 
    } else if (plan === 'ULTRA') { 
        badgeEl.style.color = '#E0B0FF'; // Roxo Vibrante
        badgeEl.style.borderColor = '#A020F0'; 
        badgeEl.style.backgroundColor = 'rgba(160, 32, 240, 0.1)'; 
    } else { 
        // FREE
        badgeEl.style.color = '#999'; 
        badgeEl.style.borderColor = '#555'; 
        badgeEl.style.backgroundColor = 'transparent'; 
    }

    // üíé O SEGREDO: Salvar na mem√≥ria do telem√≥vel para n√£o perder ao reiniciar
    let currentUser = JSON.parse(localStorage.getItem('njila_user_session') || '{}');
    if (currentUser.plan !== plan) {
        currentUser.plan = plan;
        localStorage.setItem('njila_user_session', JSON.stringify(currentUser));
        console.log("Plano sincronizado localmente: " + plan);
    }
}

// --- 2. A L√ìGICA DE ENVIO E RECE√á√ÉO (COM PROTE√á√ÉO DE ERRO) ---
function sendMessage(txtOverride){
  const t = document.getElementById('user-input');
  const txt = txtOverride || t.value.trim();
  if(!txt && state.fileList.length === 0) return;
  
  // Limpa tags HTML para seguran√ßa
  const safeTxt = txt.replace(/<[^>]*>/g, "");

  // UI: Fecha o Hero, abre o chat
  document.body.classList.add('chat-active');
  const hero = document.getElementById('hero-screen');
  if(hero) hero.style.setProperty('display', 'none', 'important');
  document.getElementById('chat-display').style.display='flex'; 
  
  // Prepara visualiza√ß√£o de arquivos
  let filesPayload = null; let gridHtml = "";
  if(state.fileList.length > 0) {
      filesPayload = state.fileList;
      gridHtml = `<div class="user-gallery-scroll">`;
      state.fileList.forEach(f => {
          if(f.mimeType.includes('image')) {
              gridHtml += `<img src="data:${f.mimeType};base64,${f.base64}" class="user-file-thumb">`;
          } else {
              gridHtml += `<div class="user-doc-thumb">üìÑ</div>`;
          }
      });
      gridHtml += `</div>`;
  }

  // Mostra mensagem do usu√°rio
  let userMsgDisplay = gridHtml + (safeTxt ? safeTxt.replace(/\n/g,'<br>') : "");
  appendMsg(userMsgDisplay, 'user', null, false);
  
  // Salva localmente
  const userMsgObj = { role: 'user', text: safeTxt, imageUrl: null };
  saveToLocal(state.chatId, userMsgObj);
  if(state.chatId) bumpChatToTop(state.chatId);

  // Limpa input
  t.value=''; t.style.height = '24px'; 
  clearFile(); 
  isUserScrolling = false; scrollToBottom();
  
  // Estado de carregamento
  isGenerating = true; updateMicSendState();
  activeGenToken++; 
  const myToken = activeGenToken; 

  // Anima√ß√£o de pensar (Pontinhos)
  const id='msg-'+Date.now();
  const html = `<div class="msg-bubble-wrap"><div class="typing-indicator" id="${id}"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div></div>`;
  const d = document.createElement('div'); d.className = `msg-row ai`; d.innerHTML = html;
  document.getElementById('chat-display').appendChild(d);
  scrollToBottom();

  // CHAMADA AO C√âREBRO (GS)
  google.script.run.withSuccessHandler(r => {
      // Verifica se o usu√°rio clicou em STOP
      if(activeGenToken !== myToken) return;
      
      // Remove a anima√ß√£o de pensar
      const el = document.getElementById(id);
      if(el) { el.closest('.msg-row').remove(); } 

      // üíé ATUALIZA√á√ÉO DO PLANO (CORRE√á√ÉO DE COMUNICA√á√ÉO)
      if (r.userPlan) {
          updateUserBadge(r.userPlan);
      }

      // Tratamento de Limites de Plano
      if(r && (r.upgradeRequired || r.errorType === 'PLAN_LIMIT')) {
          isGenerating = false; updateMicSendState(); 
          // Usa o modal de planos em vez de alerta feio
          openPlanModal(); 
          showToast(r.text.split('\n')[0]); // Mostra s√≥ o t√≠tulo no toast
          return;
      }
      
      // Extra√ß√£o de Imagem e Texto
      let imgUrl = r.imageUrl;
      let textContent = (r && r.text) ? r.text : "";

      // Limpeza de JSONs residuais
      if(textContent.includes('{"image":')) {
          textContent = textContent.replace(/```json[\s\S]*?```/g, "").replace(/\{"image":[\s\S]*?\}/g, "").trim();
          if(!textContent) textContent = "Aqui est√° o resultado.";
      }

      // Detec√ß√£o de link Pollinations (Para Imagens)
      if (textContent.includes('pollinations.ai')) {
          const urlMatch = textContent.match(/https?:\/\/image\.pollinations\.ai\/prompt\/[^"'\s\)]+/);
          if (urlMatch) {
              let cleanPrompt = decodeURIComponent(urlMatch[0].split('/prompt/')[1]);
              cleanPrompt = cleanPrompt.replace(/[()]/g, '');
              imgUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(cleanPrompt)}?width=1024&height=1024&nologo=true&n=${Date.now()}`;
              textContent = textContent.replace(urlMatch[0], '').replace(/!\[.*?\]\(.*?\)/g, '').trim();
          }
      }

      // Exibe a resposta
      appendMsg(textContent, 'ai', imgUrl, true);
      
      // Atualiza ID do chat se for novo
      if(r && r.chatId) { 
          state.chatId = r.chatId; 
          if(activeGenToken === myToken) {
             saveToLocal(state.chatId, { role: 'ai', text: r.text, imageUrl: imgUrl });
             bumpChatToTop(state.chatId);
             loadSidebar();
          }
      }

  }).withFailureHandler(e => {
      // üõ°Ô∏è TRATAMENTO DE ERRO ELEGANTE (SEM MENSAGEM AMARELA)
      if(activeGenToken !== myToken) return;
      
      const el = document.getElementById(id);
      if(el) { el.closest('.msg-row').remove(); }
      
      // Em vez de mostrar erro t√©cnico, pede para tentar de novo suavemente
      appendMsg("A conex√£o oscilou ligeiramente. Poderia repetir, por favor?", 'ai', null, true);
      isGenerating = false; 
      updateMicSendState();
      console.log("Erro oculto:", e); // Erro fica s√≥ no console
  }).processUserInput(safeTxt, state.chatId, filesPayload, state.region, null, 0, state.security.incognito, state.deviceId, state.language, state.userEmail);
}

function fixDriveLink(url) {
    if (!url) return "";
    if (url.includes('pollinations.ai')) return url;
    if (url.includes('drive.google.com')) {
        const idMatch = url.match(/\/d\/(.*?)\/|id=(.*?)&/);
        let id = null;
        if(idMatch) id = idMatch[1] || idMatch[2];
        if (id) return `https://drive.google.com/thumbnail?id=${id}&sz=s4000`;
    }
    return url;
}

function resurrectMsg() { sendMessage("Continue exatamente de onde parou, expandindo a ideia."); }

function copyText(id) { navigator.clipboard.writeText(document.getElementById(id).innerText); showToast("Copiado!"); }
function shareMsg(id) { 
    if(navigator.share) {
        navigator.share({text: document.getElementById(id).innerText}); 
    } else { 
        copyText(id); 
        showToast("Texto copiado (Partilha indispon√≠vel no PC)"); 
    } 
}
function rateMsg(el) { el.classList.toggle('active'); showToast("Obrigado!"); }
function autoResize(e){ e.style.height='24px'; e.style.height=e.scrollHeight+'px'; }
function openSidebar(){ document.getElementById('sidebar').classList.add('open'); document.getElementById('mobile-overlay').style.display='block'; }
function closeAll(){ document.getElementById('sidebar').classList.remove('open'); document.getElementById('mobile-overlay').style.display='none'; document.getElementById('google-menu').style.display='none'; closeSheet(); closeModals(); }
function closeModals(){ document.querySelectorAll('.modal-overlay').forEach(m=>m.style.display='none'); }

function startNewChat(){ 
    state.chatId=null; 
    closeAll(); 
    document.getElementById('chat-display').innerHTML=''; 
    document.getElementById('chat-display').style.display='none'; 
    const hero = document.getElementById('hero-screen');
    if(hero) hero.style.setProperty('display', 'flex', 'important'); 
    
    document.body.classList.remove('chat-active'); 
    document.getElementById('user-input').value=''; 
    updateMicSendState(); 
}

function toggleGoogleMenu(){ 
    const m=document.getElementById('google-menu'); 
    const isHidden = (m.style.display === 'none' || m.style.display === '');
    if(isHidden) { m.style.display='flex'; document.body.classList.add('njila-pro-ativo'); } 
    else { m.style.display='none'; document.body.classList.remove('njila-pro-ativo'); }
}

function openSettingsModal(){ document.getElementById('modal-settings').style.display='flex'; switchSetTab('general'); }
function switchSetTab(t){ document.querySelectorAll('.set-tab').forEach(e=>e.classList.remove('active')); document.getElementById('tab-'+t).classList.add('active'); document.getElementById('panel-general').style.display = (t==='general') ? 'block' : 'none'; document.getElementById('panel-security').style.display = (t==='security') ? 'block' : 'none'; }

function openPlanModal(){ 
    const r = REGION_DATA[state.region] || REGION_DATA['Angola']; const wppBase = "https://wa.me/244973185721?text=";
    const msgPro = encodeURIComponent(`Ol√°! Quero ativar o Njila PRO (${r.preco}).`); const msgUltra = encodeURIComponent(`Ol√°! Quero ativar o Njila ULTRA (${r.precoUltra}).`);
    const listStyle = "list-style:none; padding:0; margin:15px 0 0 0; text-align:left; font-size:12px; line-height:1.8; color:var(--text-secondary);";
    const checkItem = (txt) => `<li><span style="color:var(--accent); margin-right:8px; font-weight:bold">‚úì</span>${txt}</li>`;
    const html = `<div class="plan-card"><div class="plan-header"><span class="plan-name">Inicial</span><span class="plan-price" style="font-size:16px">${r.precoBasic}</span></div><div class="plan-desc">Para come√ßar.</div><ul style="${listStyle}">${checkItem("‚ú® IA Standard (R√°pida)")}${checkItem("üìÇ <b>1 Arquivo por vez</b>")}${checkItem("üí¨ Conversas de Teste")}</ul><button class="plan-btn btn-outline" style="margin-top:15px; cursor:default; opacity:0.6">Seu Plano Atual</button></div><div class="plan-card highlight"><div style="position:absolute; top:-10px; right:20px; background:var(--accent); color:var(--bg-body); font-size:10px; padding:4px 8px; border-radius:4px; font-weight:800;">RECOMENDADO</div><div class="plan-header"><span class="plan-name">Pro</span><span class="plan-price">${r.moeda} ${r.preco}</span></div><div class="plan-desc">Para quem produz.</div><ul style="${listStyle}">${checkItem("üß† <b>IA Neural (Racioc√≠nio)</b>")}${checkItem("üìÇ <b>5 Arquivos SIMULT√ÇNEOS</b>")}${checkItem("‚ôæÔ∏è <b>Uso Di√°rio Ilimitado</b>*")}</ul><div style="font-size:10px;color:#666;margin-top:5px;font-style:italic">Analise quantos quiser por dia, 5 de cada vez.</div><button class="plan-btn" style="margin-top:10px;" onclick="window.open('${wppBase}${msgPro}', '_blank')">ATIVAR PRO</button></div><div class="plan-card"><div class="plan-header"><span class="plan-name">Ultra</span><span class="plan-price">${r.moeda} ${r.precoUltra}</span></div><div class="plan-desc">Poder m√°ximo.</div><ul style="${listStyle}">${checkItem("‚ö° <b>C√©rebro Supremo</b>")}${checkItem("üìö <b>10 Arquivos SIMULT√ÇNEOS</b>")}${checkItem("‚ôæÔ∏è <b>Gera√ß√µes Ilimitadas</b>*")}</ul><button class="plan-btn btn-outline" style="margin-top:10px; border-color:var(--accent); color:var(--accent)" onclick="window.open('${wppBase}${msgUltra}', '_blank')">ATIVAR ULTRA</button></div>`;
    document.getElementById('plans-grid').innerHTML = html; document.getElementById('modal-plan').style.display='flex'; 
}

function openLegalModal(){ document.getElementById('modal-legal').style.display='flex'; switchLegalTab('terms'); }
function openHelpModal(){ document.getElementById('modal-help').style.display='flex'; }
function switchLegalTab(t){ document.querySelectorAll('.legal-tab').forEach(e=>e.classList.remove('active')); document.getElementById('tab-btn-'+t).classList.add('active'); document.querySelectorAll('.legal-content').forEach(e=>e.classList.remove('active-content')); document.getElementById('legal-txt-'+t).classList.add('active-content'); }
function switchGateTab(t){ document.querySelectorAll('.legal-tab').forEach(e=>e.classList.remove('active')); document.getElementById('gate-tab-'+t).classList.add('active'); document.getElementById('gate-txt-terms').style.display = t==='terms'?'block':'none'; document.getElementById('gate-txt-privacy').style.display = t==='privacy'?'block':'none'; }
function triggerCard(type){ let txt = ""; if(type==='poema') txt = "Escreva um poema curto."; if(type==='business') txt = "Crie um plano."; if(type==='image') txt = "Gere uma imagem."; if(type==='code') txt = "Crie um c√≥digo HTML."; document.getElementById('user-input').value = txt; document.getElementById('user-input').focus(); }

function filterChats() {
    const query = document.getElementById('chat-search-input').value.toLowerCase();
    const chats = document.querySelectorAll('.nav-item-clean');
    chats.forEach(chat => {
        const text = chat.innerText.toLowerCase();
        chat.style.display = text.includes(query) ? 'flex' : 'none';
    });
}

function loadSidebar(){ const cachedChats = JSON.parse(localStorage.getItem('njila_chats') || '[]'); state.pinnedChats = JSON.parse(localStorage.getItem('njila_pinned') || '[]'); renderChatList(cachedChats); renderPinnedHeader(); google.script.run.withSuccessHandler(chats=>{ if(chats && chats.length > 0) { localStorage.setItem('njila_chats', JSON.stringify(chats)); renderChatList(chats); } }).getUserChatList(state.deviceId, state.userEmail); }
function renderChatList(chats) { const l=document.getElementById('chat-list-container'); l.innerHTML=''; if(!chats || chats.length===0) { l.innerHTML='<div style="padding:20px;font-size:12px;color:#666">Sem hist√≥rico</div>'; return; } chats.forEach(c=>{ const isPinned = state.pinnedChats.includes(c.id); const isActive = c.id === state.chatId; const d=document.createElement('div'); d.className = `nav-item-clean ${isActive ? 'active' : ''}`; d.innerHTML = `<span class="nav-text">${c.title}</span>`; d.onclick = () => { loadChatById(c.id); }; d.oncontextmenu = (e) => { e.preventDefault(); openContext(c.id); }; l.appendChild(d); }); filterChats(); }
function renderPinnedHeader() { const c = document.getElementById('header-pinned-area'); c.innerHTML = ''; const allChats = JSON.parse(localStorage.getItem('njila_chats') || '[]'); const pinned = allChats.filter(chat => state.pinnedChats.includes(chat.id)); pinned.forEach(chat => { const chip = document.createElement('div'); chip.className = `pinned-chip ${chat.id === state.chatId ? 'active' : ''}`; chip.innerHTML = `<span style="font-size:12px">üìå</span> ${chat.title}`; chip.onclick = () => loadChatById(chat.id); c.appendChild(chip); }); }

function loadChatById(id) { 
    state.chatId = id; 
    closeAll(); 
    document.body.classList.add('chat-active'); 
    const hero = document.getElementById('hero-screen');
    if(hero) hero.style.setProperty('display', 'none', 'important');
    document.getElementById('chat-display').style.display='flex'; 
    document.getElementById('chat-display').innerHTML=''; 
    loadFromLocal(id); 
    renderPinnedHeader(); 
    loadSidebar(); 
    // PEDIDO 2: Ao carregar chat, vai pro fundo
    isUserScrolling = false;
    setTimeout(scrollToBottom, 100);
    
    google.script.run.withSuccessHandler(h => { 
        if(h && h.length){ 
            const oldData = localStorage.getItem('njila_msg_' + id); 
            const newData = JSON.stringify(h); 
            if(oldData !== newData) { 
                localStorage.setItem('njila_msg_' + id, newData); 
                document.getElementById('chat-display').innerHTML = ''; 
                h.forEach(m => appendMsg(m.text, m.role === 'user'?'user':'ai', m.imageUrl, false)); 
                setTimeout(scrollToBottom, 100);
            } 
        } 
    }).getChatHistory(id, state.deviceId, state.userEmail); 
}

function openContext(id) { state.targetChatId = id; document.getElementById('chat-options-sheet').style.display='block'; setTimeout(()=>document.getElementById('sheet-content').style.transform='translateY(0)',10); }
function closeSheet() { document.getElementById('sheet-content').style.transform='translateY(100%)'; setTimeout(()=>document.getElementById('chat-options-sheet').style.display='none',300); }

// --- SISTEMA DE CONFIRMA√á√ÉO ---
let pendingAction = null; 

function openConfirm(msg, actionCallback) {
    document.getElementById('confirm-msg').innerText = msg;
    pendingAction = actionCallback;
    document.getElementById('btn-confirm-yes').onclick = function() {
        if (pendingAction) pendingAction();
        closeConfirm();
    };
    document.getElementById('modal-confirm').style.display = 'flex';
}

function closeConfirm() {
    document.getElementById('modal-confirm').style.display = 'none';
    pendingAction = null;
}

function sheetAction(a){ 
    closeSheet(); 
    if(a === 'delete') { 
        openConfirm("Deseja mesmo apagar este chat permanentemente?", () => {
            state.pinnedChats = state.pinnedChats.filter(pid => pid !== state.targetChatId); 
            localStorage.setItem('njila_pinned', JSON.stringify(state.pinnedChats)); 
            const isCurrent = (state.targetChatId === state.chatId); 
            renderChatList(JSON.parse(localStorage.getItem('njila_chats') || '[]').filter(c => c.id !== state.targetChatId));
            google.script.run.withSuccessHandler(() => { 
                loadSidebar(); 
                if(isCurrent) startNewChat(); 
                showToast("Chat eliminado."); 
            }).deleteChat(state.targetChatId);
        });
    } 
    if(a === 'rename') { openCustomPrompt("Novo Nome", (newName) => { google.script.run.withSuccessHandler(() => { showToast("Renomeado!"); loadSidebar(); }).renameChat(state.targetChatId, newName); }); } 
    if(a === 'pin') { if(state.pinnedChats.includes(state.targetChatId)) state.pinnedChats = state.pinnedChats.filter(pid => pid !== state.targetChatId); else state.pinnedChats.push(state.targetChatId); localStorage.setItem('njila_pinned', JSON.stringify(state.pinnedChats)); loadSidebar(); } 
    if(a === 'share') shareMsg(state.targetChatId); 
}

function openGalleryModal(){ 
    closeAll();
    document.getElementById('modal-gallery').style.display='flex'; 
    google.script.run.withSuccessHandler(imgs => { 
        const c=document.getElementById('gallery-container'); 
        const empty = document.getElementById('gallery-empty'); 
        if(imgs && imgs.length){ 
            empty.style.display='none'; 
            c.innerHTML = imgs.map(i=>`
                <div style="position:relative; margin-bottom:0; break-inside:avoid;">
                    <img src="${i.url}" style="width:100%; border-radius:12px; display:block; border:1px solid #333; aspect-ratio:1; object-fit:cover;" onclick="openFullImage('${i.url}')">
                    <div onclick="forceDownload('${i.url}', this)" style="position:absolute; bottom:8px; right:8px; background:rgba(0,0,0,0.8); color:#fff; border-radius:50%; width:35px; height:35px; display:flex; align-items:center; justify-content:center; cursor:pointer; box-shadow:0 2px 5px rgba(0,0,0,0.5); border:1px solid rgba(255,255,255,0.2);">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                    </div>
                </div>
            `).join(''); 
        } else { c.innerHTML=''; empty.style.display='block'; } 
    }).getUserImages(state.deviceId, state.userEmail); 
}

async function forceDownload(url, btnElement) { 
    if(btnElement && btnElement.style) {
        if(btnElement.style.pointerEvents === 'none') return;
        var originalContent = btnElement.innerHTML;
        btnElement.innerHTML = '<span style="animation:spin 1s infinite linear; font-size:16px">‚Üª</span>';
        btnElement.style.pointerEvents = 'none'; 
    }
    try {
        const r = await fetch(url);
        const b = await r.blob();
        const u = window.URL.createObjectURL(b);
        const a = document.createElement('a'); a.href = u; a.download = 'Njila_Img.png'; 
        document.body.appendChild(a); a.click(); document.body.removeChild(a); 
        if(btnElement) {
            btnElement.innerHTML = '<span style="font-size:16px; color:#00e676">‚úì</span>';
            setTimeout(() => { btnElement.innerHTML = originalContent; btnElement.style.pointerEvents = 'auto'; }, 2000);
        }
    } catch(e) { 
        window.open(url,'_blank'); 
        if(btnElement) {
            btnElement.innerHTML = '<span style="font-size:16px; color:red">‚úï</span>';
            setTimeout(() => { btnElement.innerHTML = originalContent; btnElement.style.pointerEvents = 'auto'; }, 2000);
        }
    } 

function openFullImage(url){state.currentImgUrl=url;document.getElementById('img-full-view').src=url;document.getElementById('img-overlay').style.display='flex';}
function closeImgOverlay(){document.getElementById('img-overlay').style.display='none';}
function downloadCurrentImg(){ if(state.currentImgUrl) forceDownload(state.currentImgUrl, document.querySelector('#img-overlay button')); }
function shareCurrentImg(){ if(state.currentImgUrl && navigator.share) navigator.share({url:state.currentImgUrl}); }

function toggleSecurity(k){const v=document.getElementById(k==='safe_mode'?'sw-safemode':'sw-incognito').checked;state.security[k]=v;google.script.run.saveUserSetting(k,v, state.deviceId); showToast("Seguran√ßa Atualizada");}

function checkSessionOnStart() { 
    const savedSession = localStorage.getItem('njila_user_session'); 
    if (savedSession) { 
        const u = JSON.parse(savedSession); 
        onLoginSuccess(u); 
    } else {
        document.getElementById('login-screen').style.display = 'flex';
        if(localStorage.getItem('njila_terms_accepted') !== 'true') {
             document.getElementById('terms-gatekeeper').style.display = 'flex';
        }
    }
}

function acceptTerms() { if(document.getElementById('chk-accept').checked){ localStorage.setItem('njila_terms_accepted', 'true'); document.getElementById('terms-gatekeeper').style.display = 'none'; } else alert("Aceite os termos."); }
function closeInputModal() { document.getElementById('modal-input').style.display='none'; }
function openCustomPrompt(title, callback) { document.getElementById('input-title').innerText = title; const inp = document.getElementById('custom-input-field'); inp.value = ''; document.getElementById('modal-input').style.display = 'flex'; inp.focus(); document.getElementById('btn-input-confirm').onclick = () => { if(inp.value.trim().length > 0) { callback(inp.value.trim()); document.getElementById('modal-input').style.display = 'none'; } }; }

function saveToLocal(chatId, msg) { 
    if(!chatId || chatId === 'novo') return; 
    let history = JSON.parse(localStorage.getItem('njila_msg_' + chatId) || '[]'); 
    let safeMsg = { ...msg };
    if (safeMsg.role === 'ai' && safeMsg.text && safeMsg.text.includes('{"image":')) {
        safeMsg.text = "[Sistema: Imagem gerada com sucesso. Detalhes t√©cnicos ocultos para manter contexto.]";
    }
    history.push(safeMsg); 
    localStorage.setItem('njila_msg_' + chatId, JSON.stringify(history)); 
}

function loadFromLocal(chatId) { const history = JSON.parse(localStorage.getItem('njila_msg_' + chatId) || '[]'); history.forEach(m => appendMsg(m.text, m.role, m.imageUrl, false)); }

function doLogout() { 
    const app = document.getElementById('app-container');
    app.style.transition = 'transform 0.4s ease, opacity 0.4s ease';
    app.style.transform = 'translateX(-100%)';
    app.style.opacity = '0';
    setTimeout(() => {
        localStorage.removeItem('njila_terms_accepted'); 
        localStorage.removeItem('njila_user_session'); 
        localStorage.removeItem('njila_chats'); 
        state.userEmail = null; state.chatId = null; state.security.pin = null; 
        document.getElementById('chat-list-container').innerHTML = ''; 
        document.getElementById('chat-display').innerHTML = ''; 
        document.getElementById('header-pinned-area').innerHTML = ''; 
        app.style.display='none'; app.style.transform = 'translateX(0)'; app.style.opacity = '1';
        document.getElementById('google-menu').style.display='none'; 
        const login = document.getElementById('login-screen');
        login.style.display='flex'; login.style.transform = 'translateY(100%)';
        setTimeout(() => login.style.transform = 'translateY(0)', 10); 
        document.getElementById('manual-name').value=''; 
        document.getElementById('manual-email').value=''; 
        document.getElementById('btn-login-trigger').style.opacity = '1'; 
        document.getElementById('btn-login-trigger').innerText="ENTRAR"; 
        showToast("Sess√£o terminada"); 
    }, 400);
}

function manualLogin() { 
    const nome = document.getElementById('manual-name').value.trim(); 
    const email = document.getElementById('manual-email').value.trim(); 
    if (nome.length < 2) { showToast("Por favor, diga o seu nome."); return; } 
    if (!email.includes('@') || email.length < 5) { showToast("Email inv√°lido."); return; } 
    localStorage.removeItem('njila_chats');
    document.getElementById('chat-list-container').innerHTML = '';
    document.getElementById('btn-login-trigger').style.opacity = '0.7'; 
    document.getElementById('btn-login-trigger').innerText = "A entrar..."; 
    const user = { email: email, displayEmail: email, displayName: nome, settings: {} }; 
    localStorage.setItem('njila_user_session', JSON.stringify(user)); 
    onLoginSuccess(user); 
}

function onLoginSuccess(u){ 
    state.userEmail = u.email; 
    localStorage.setItem('njila_user_session', JSON.stringify(u)); 
    let name = u.displayName || "Visitante"; 
    if(name === "Visitante" && u.email.includes('@')) { name = u.email.split('@')[0]; } 
    name = name.charAt(0).toUpperCase() + name.slice(1); 
    document.getElementById('gm-welcome').innerText = "Ol√°, " + name; 
    document.getElementById('header-avatar').innerText = name.charAt(0).toUpperCase(); 
    document.getElementById('big-avatar-letter').innerText = name.charAt(0).toUpperCase();

    const plan = u.plan || 'FREE';
    const badgeEl = document.querySelector('.gm-badge');
    if(badgeEl) {
        badgeEl.innerText = plan;
        if(plan === 'PRO') { badgeEl.style.color = '#4285F4'; badgeEl.style.borderColor = '#4285F4'; badgeEl.style.backgroundColor = 'rgba(66, 133, 244, 0.1)'; } 
        else if (plan === 'ULTRA') { badgeEl.style.color = '#E0B0FF'; badgeEl.style.borderColor = '#A020F0'; badgeEl.style.backgroundColor = 'rgba(160, 32, 240, 0.1)'; } 
        else { badgeEl.style.color = '#999'; badgeEl.style.borderColor = '#555'; badgeEl.style.backgroundColor = 'transparent'; }
    }
    const login = document.getElementById('login-screen');
    if(login.style.display !== 'none') {
        login.style.transform = 'translateY(-100%)'; 
        setTimeout(() => { login.style.display='none'; checkPinOrStart(); }, 500); 
    } else {
        checkPinOrStart();
    }
}

function checkPinOrStart() {
    // üíé SE NENHUM CHAT ESTIVER CARREGADO, GARANTE QUE O HERO APARECE
    if(state.security.pin) { state.pinMode = 'UNLOCK'; document.getElementById('pin-title').innerText = "Njila Protected"; document.getElementById('pin-close-btn').style.display = "none"; document.getElementById('pin-overlay').style.display='flex'; } 
    else { 
        document.getElementById('app-container').style.display='flex'; 
        loadSidebar(); 
        if(!state.chatId) startNewChat(); // For√ßa Hero na inicializa√ß√£o se n√£o houver chat
    } 
}

function openVaultModal() {
    if(!state.security.pin) { showSmartAlert("Para usar o Cofre, precisas de um PIN.", "Criar PIN", openPinSetup); return; }
    openCustomPrompt("PIN de Acesso", (inputPin) => {
        if(inputPin === state.security.pin) {
            closeModals();
            document.getElementById('modal-vault').style.display = 'flex';
            const encryptedData = localStorage.getItem('njila_vault_' + state.userEmail);
            const vaultArea = document.getElementById('vault-content');
            const overlay = document.getElementById('vault-lock-overlay');
            if(encryptedData) { vaultArea.value = encryptedData; overlay.style.display = 'flex'; vaultArea.setAttribute('readonly', true); } 
            else { vaultArea.value = ""; overlay.style.display = 'none'; vaultArea.removeAttribute('readonly'); }
        } else { showToast("PIN Incorreto."); if(navigator.vibrate) navigator.vibrate(200); }
    });
}

function vaultAction(action) {
    const vaultArea = document.getElementById('vault-content');
    const overlay = document.getElementById('vault-lock-overlay');
    const pin = state.security.pin;
    let text = vaultArea.value;
    const processCrypto = (str, key) => { let res = ""; for(let i=0; i<str.length; i++) res += String.fromCharCode(str.charCodeAt(i) ^ key.charCodeAt(i % key.length)); return res; };

    if (action === 'encrypt') {
        if(overlay.style.display === 'flex') { showToast("J√° est√° trancado."); return; }
        if(!text.trim()) { showToast("Escreve algo primeiro."); return; }
        try {
            const encrypted = "ENC::" + btoa(processCrypto(text, pin));
            localStorage.setItem('njila_vault_' + state.userEmail, encrypted);
            google.script.run.syncVault(state.userEmail, encrypted); 
            vaultArea.value = encrypted; overlay.style.display = 'flex'; vaultArea.setAttribute('readonly', true);
            showToast("Guardado e Blindado üõ°Ô∏è");
        } catch(e) { showToast("Erro ao trancar."); }
    }
    if (action === 'decrypt') {
        if(overlay.style.display === 'none') { showToast("J√° podes editar."); return; }
        try {
            const raw = text.split("ENC::")[1];
            const decrypted = processCrypto(atob(raw), pin);
            vaultArea.value = decrypted; overlay.style.display = 'none'; vaultArea.removeAttribute('readonly'); vaultArea.focus();
        } catch(e) { showToast("Erro de leitura."); }
    }
}

// 4. PULL-TO-REFRESH F√çSICO
(function initPullToRefresh() {
    const sidebar = document.querySelector('.sidebar-scroll-area');
    let startY = 0; let isPulling = false;
    sidebar.addEventListener('touchstart', (e) => { if (sidebar.scrollTop === 0) { startY = e.touches[0].clientY; isPulling = true; } }, { passive: true });
    sidebar.addEventListener('touchmove', (e) => {
        if (!isPulling) return;
        const y = e.touches[0].clientY; const delta = y - startY;
        if (delta > 0) {
            const pull = Math.min(delta * 0.4, 150); sidebar.style.transform = `translateY(${pull}px)`;
            if (pull > 60 && !sidebar.classList.contains('vibrated')) { if(navigator.vibrate) navigator.vibrate(15); sidebar.classList.add('vibrated'); }
        }
    }, { passive: false });
    sidebar.addEventListener('touchend', () => { isPulling = false; sidebar.style.transition = 'transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1)'; sidebar.style.transform = 'translateY(0)'; sidebar.classList.remove('vibrated'); setTimeout(() => { sidebar.style.transition = ''; }, 300); });
})();

function formatCodeBlocks(containerElement) { 
    Prism.highlightAllUnder(containerElement); 
    containerElement.querySelectorAll('pre').forEach(pre => { 
        if(pre.parentNode.classList.contains('gemini-code-block')) return; 
        let lang = 'C√≥digo'; 
        const codeTag = pre.querySelector('code'); 
        if(codeTag && codeTag.className.includes('language-')) lang = codeTag.className.split('language-')[1].toUpperCase(); 
        const wrapper = document.createElement('div'); wrapper.className = 'gemini-code-block';
        const header = document.createElement('div'); header.className = 'gemini-code-header'; 
        header.innerHTML = `<span>${lang}</span><button class="copy-btn-gemini"><span style="font-size:14px">üìã</span> Copiar</button>`; 
        header.querySelector('button').onclick = () => { navigator.clipboard.writeText(codeTag.innerText); showToast("C√≥digo copiado!"); }; 
        pre.parentNode.insertBefore(wrapper, pre); wrapper.appendChild(header); wrapper.appendChild(pre); 
    }); 
}

// 5. EXPORT FROM SELECTION
function exportFromSelection(type) {
    const sel = window.getSelection();
    if(sel.rangeCount > 0) {
        const anchor = sel.anchorNode;
        const element = (anchor.nodeType === 3) ? anchor.parentNode : anchor;
        const msgRow = element.closest('.msg-row');
        if(msgRow) {
            const contentDiv = msgRow.querySelector('.msg-text-content, .msg-bubble');
            if(contentDiv && contentDiv.id) {
                exportContent(type, contentDiv.id);
            } else { showToast("N√£o foi poss√≠vel identificar a mensagem."); }
        } else { showToast("Selecione texto de uma mensagem primeiro."); }
    }
    document.getElementById('njila-context-menu').style.display = 'none';
}

function exportContent(type, id) {
    const el = document.getElementById(id); if (!el) return;
    const cleanNode = el.cloneNode(true);
    cleanNode.querySelectorAll('button, .img-ctrl-pill, .msg-actions').forEach(e => e.remove());
    if(type === 'pdf') {
        const pdfBox = document.createElement('div');
        pdfBox.style.cssText = "font-family: Arial; color:#000; background:#fff; padding:30px; width:100%; text-align:justify !important; line-height: 1.5;";
        Array.from(cleanNode.childNodes).forEach(node => {
             if(node.nodeType === 1) { 
                 node.style.textAlign = 'justify'; 
                 if(node.tagName === 'PRE') { node.style.background='#f4f4f4'; node.style.border='1px solid #ccc'; node.style.whiteSpace='pre-wrap'; }
             }
             pdfBox.appendChild(node.cloneNode(true));
        });
        const opt = { margin: 15, filename: `Njila_PDF_${Date.now()}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } };
        showToast("Gerando PDF...");
        html2pdf().set(opt).from(pdfBox).save();
    }
}

function toggleAttachMenu() { const m = document.getElementById('attach-menu'); m.style.display = (m.style.display === 'flex') ? 'none' : 'flex'; }
function triggerUpload(type) { if(type === 'doc') document.getElementById('file-upload-doc').click(); if(type === 'img') document.getElementById('file-upload-img').click(); if(type === 'cam') document.getElementById('file-upload-cam').click(); }

function handleFileSelect(e){ const files = e.target.files; if(!files.length) return; Array.from(files).forEach(f => { const r = new FileReader(); r.onload = function(ev){ state.fileList.push({ mimeType: f.type, base64: ev.target.result.split(',')[1], name: f.name }); updateStackPreview(); updateMicSendState(); }; r.readAsDataURL(f); }); e.target.value = ''; }
function updateStackPreview(){ const c = document.getElementById('file-stack-container'); const area = document.getElementById('file-stack-container'); const badge = document.getElementById('file-count-badge'); c.innerHTML = ''; if(state.fileList.length > 0) { document.getElementById('file-stack-wrapper').style.display = 'block'; badge.innerText = "+" + state.fileList.length; badge.style.display = (state.fileList.length > 0) ? 'block' : 'none'; state.fileList.forEach((f, idx) => { const thumb = document.createElement('div'); thumb.className = 'mini-thumb'; if(f.mimeType.includes('image')) thumb.style.backgroundImage = `url(data:${f.mimeType};base64,${f.base64})`; else thumb.innerText = 'üìÑ'; const close = document.createElement('div'); close.className='mini-thumb-close'; close.innerText='x'; close.onclick = () => { state.fileList.splice(idx,1); updateStackPreview(); }; thumb.appendChild(close); c.appendChild(thumb); }); } else { document.getElementById('file-stack-wrapper').style.display = 'none'; badge.style.display = 'none'; } }
function clearFile(){ state.fileList=[]; updateStackPreview(); updateMicSendState(); }

// 6. MENU DE CONTEXTO
const njilaMenu = document.getElementById('njila-context-menu');
let selectionTimer = null;
document.addEventListener('selectionchange', () => { if (!window.getSelection().toString().trim()) { hideMenu(); } });
document.addEventListener('touchstart', () => { hideMenu(); });
document.addEventListener('touchend', () => { clearTimeout(selectionTimer); selectionTimer = setTimeout(() => { if (window.getSelection().toString().trim().length > 0) { showMenu(); } }, 200); });
function showMenu() { njilaMenu.style.display = 'flex'; void njilaMenu.offsetWidth; njilaMenu.style.opacity = '1'; njilaMenu.style.transform = 'translate(-50%, -50%) scale(1)'; }
function hideMenu() { njilaMenu.style.opacity = '0'; njilaMenu.style.transform = 'translate(-50%, -50%) scale(0.95)'; setTimeout(() => { if(njilaMenu.style.opacity === '0') njilaMenu.style.display = 'none'; }, 200); }
function execCmd(cmd) { const s = window.getSelection().toString(); if(cmd === 'copy') { navigator.clipboard.writeText(s); showToast("Copiado!"); } if(cmd === 'share') { if(navigator.share) navigator.share({text: s}); else { navigator.clipboard.writeText(s); showToast("Copiado!"); } } hideMenu(); }

(function() { const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d'); const container = document.getElementById('universe-canvas'); if(!container) return; container.appendChild(canvas); let width, height; let stars = []; function resize() { width = window.innerWidth; height = window.innerHeight; canvas.width = width; canvas.height = height; stars = []; for (let i = 0; i < 60; i++) { stars.push({ x: Math.random() * width, y: Math.random() * height, r: Math.random() * 2, a: Math.random(), s: 0.02 + Math.random() * 0.05 }); } } function animate() { ctx.clearRect(0, 0, width, height); ctx.fillStyle = "white"; stars.forEach(star => { star.a += star.s; if (star.a > 1 || star.a < 0) star.s = -star.s; ctx.globalAlpha = Math.abs(star.a); ctx.beginPath(); ctx.arc(star.x, star.y, star.r, 0, Math.PI * 2); ctx.fill(); }); requestAnimationFrame(animate); } window.addEventListener('resize', resize); resize(); animate(); })();
window.onload = function() { checkSessionOnStart(); };
</script>
</body>
</html>